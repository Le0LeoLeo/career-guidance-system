<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ·»åŠ å¤§å­¸ç§‘ç³»å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      padding: 30px;
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 2em;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .section h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.5em;
    }
    
    .button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: all 0.3s;
    }
    
    .button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .button.danger {
      background: #e74c3c;
    }
    
    .button.danger:hover {
      background: #c0392b;
    }
    
    .button.success {
      background: #27ae60;
    }
    
    .button.success:hover {
      background: #229954;
    }
    
    .university-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      background: white;
    }
    
    .university-item {
      padding: 12px;
      margin: 8px 0;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .university-item.no-majors {
      border-left: 4px solid #e74c3c;
      background: #fff5f5;
    }
    
    .university-item.has-majors {
      border-left: 4px solid #27ae60;
    }
    
    .university-info {
      flex: 1;
    }
    
    .university-name {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    
    .university-details {
      font-size: 0.9em;
      color: #666;
    }
    
    .majors-count {
      margin-right: 15px;
      padding: 4px 12px;
      background: #667eea;
      color: white;
      border-radius: 12px;
      font-size: 0.85em;
    }
    
    .majors-count.zero {
      background: #e74c3c;
    }
    
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
    }
    
    .log-entry {
      margin: 5px 0;
      padding: 3px 0;
    }
    
    .log-entry.success {
      color: #4ec9b0;
    }
    
    .log-entry.error {
      color: #f48771;
    }
    
    .log-entry.info {
      color: #569cd6;
    }
    
    .log-entry.warning {
      color: #dcdcaa;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .stat-number {
      font-size: 2.5em;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }
    
    .stat-label {
      color: #666;
      font-size: 0.9em;
    }
    
    .common-majors {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    .major-tag {
      background: #e8eaf6;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 0.9em;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“ æ·»åŠ å¤§å­¸ç§‘ç³»å·¥å…·ï¼ˆAI æ™ºèƒ½åˆ¤å®šï¼‰</h1>
    <p class="subtitle">ä½¿ç”¨æ–‡å¿ƒ AI æ ¹æ“šå­¸æ ¡å¯¦éš›æƒ…æ³åˆ¤å®šä¸¦æ·»åŠ ç§‘ç³»</p>
    
    <div class="section">
      <h2>ğŸ“Š çµ±è¨ˆè³‡è¨Š</h2>
      <div class="stats" id="stats">
        <div class="stat-card">
          <div class="stat-number" id="total-universities">-</div>
          <div class="stat-label">ç¸½å¤§å­¸æ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="no-majors-count">-</div>
          <div class="stat-label">ç¼ºå°‘ç§‘ç³»</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="has-majors-count">-</div>
          <div class="stat-label">å·²æœ‰ç§‘ç³»</div>
        </div>
      </div>
    </div>
    
    <div class="section">
      <h2>ğŸ” æª¢æŸ¥å¤§å­¸ç§‘ç³»</h2>
      <button class="button" onclick="checkUniversities()">æª¢æŸ¥æ‰€æœ‰å¤§å­¸</button>
      <button class="button success" onclick="addMajorsToAll()">ç‚ºæ‰€æœ‰ç¼ºå°‘ç§‘ç³»çš„å¤§å­¸æ·»åŠ ç§‘ç³»</button>
      <div id="university-list" class="university-list" style="display: none; margin-top: 20px;"></div>
    </div>
    
    <div class="section">
      <h2>ğŸ“Š æœç´¢å¤§å­¸éŒ„å–åˆ†æ•¸</h2>
      <p style="color: #666; margin-bottom: 15px;">ä½¿ç”¨æ–‡å¿ƒ Web Search æœç´¢å¤§å­¸å„ç§‘ç³»çš„éŒ„å–åˆ†æ•¸ï¼Œä¸¦æŒ‰å¹´ä»½ä¿å­˜åˆ° Firebase</p>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; color: #333; font-weight: bold;">é¸æ“‡å¹´ä»½ï¼š</label>
        <select id="search-year" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; margin-right: 10px;">
          <option value="2024">2024å¹´</option>
          <option value="2023">2023å¹´</option>
          <option value="2025">2025å¹´</option>
        </select>
        <button class="button" onclick="searchAdmissionScoresForAll()">æœç´¢æ‰€æœ‰å¤§å­¸çš„éŒ„å–åˆ†æ•¸</button>
        <button class="button success" onclick="searchAdmissionScoresForSelected()">æœç´¢é¸ä¸­å¤§å­¸çš„éŒ„å–åˆ†æ•¸</button>
      </div>
      <div id="admission-scores-list" class="university-list" style="display: none; margin-top: 20px;"></div>
    </div>
    
    <div class="section">
      <h2>ğŸ“‹ æŸ¥çœ‹å’Œç®¡ç†éŒ„å–åˆ†æ•¸</h2>
      <p style="color: #666; margin-bottom: 15px;">æŸ¥çœ‹ã€ç·¨è¼¯å’Œç®¡ç†å·²ä¿å­˜çš„éŒ„å–åˆ†æ•¸æ•¸æ“š</p>
      <div style="margin-bottom: 15px;">
        <button class="button" onclick="loadAllAdmissionScores()">è¼‰å…¥æ‰€æœ‰éŒ„å–åˆ†æ•¸</button>
        <button class="button" onclick="viewAdmissionScoresByYear()">æŒ‰å¹´ä»½æŸ¥çœ‹</button>
        <button class="button" onclick="viewAdmissionScoresByUniversity()">æŒ‰å¤§å­¸æŸ¥çœ‹</button>
        <button class="button success" onclick="exportAdmissionScores()">å°å‡ºç‚º JSON</button>
      </div>
      <div id="admission-scores-view" style="display: none; margin-top: 20px;">
        <div id="admission-scores-content" class="university-list"></div>
      </div>
    </div>
    
    <div class="section">
      <h2>ğŸ¤– AI åˆ¤å®šèªªæ˜</h2>
      <p>æœ¬å·¥å…·ä½¿ç”¨æ–‡å¿ƒ AI æ ¹æ“šä»¥ä¸‹å­¸æ ¡è³‡è¨Šæ™ºèƒ½åˆ¤å®šç§‘ç³»ï¼š</p>
      <ul style="margin-left: 20px; margin-top: 10px; color: #666;">
        <li>å­¸æ ¡åç¨±ï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰</li>
        <li>å­¸æ ¡é¡å‹ï¼ˆå…¬ç«‹/ç§ç«‹ï¼‰</li>
        <li>å­¸æ ¡æ‰€åœ¨åœ°å€</li>
        <li>å­¸æ ¡ç‰¹è‰²èˆ‡å®šä½</li>
      </ul>
      <p style="margin-top: 15px; color: #667eea; font-weight: bold;">âœ¨ AI æœƒæ ¹æ“šæ¯æ‰€å­¸æ ¡çš„å¯¦éš›æƒ…æ³ç”Ÿæˆæœ€é©åˆçš„ç§‘ç³»åˆ—è¡¨</p>
    </div>
    
    <div class="section">
      <h2>ğŸ“‹ æ“ä½œæ—¥èªŒ</h2>
      <div class="log" id="log"></div>
      <button class="button" onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyA6QVAAIBGpnt8QBAScj3gMQmnQijqX_vk",
      authDomain: "cpaapp-8c4d6.firebaseapp.com",
      projectId: "cpaapp-8c4d6",
      storageBucket: "cpaapp-8c4d6.firebasestorage.app",
      messagingSenderId: "182638554959",
      appId: "1:182638554959:web:3e5e126b379c6c68c1df3a",
      measurementId: "G-ME38DET581"
    };

    // Supabase é…ç½®
    const SUPABASE_URL = 'https://naqyczuuariosniudbsr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5hcXljenV1YXJpb3NuaXVkYnNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NzM2ODQsImV4cCI6MjA4MDM0OTY4NH0.6gLqwj0OBNHatfoPC_Pm0zANzQLS1KE9xJ2Vf2dQB7s';

    let db = null;
    let supabase = null;
    let universities = [];

    // åˆå§‹åŒ– Firebase
    function initFirebase() {
      try {
        if (typeof firebase === 'undefined') {
          log('Firebase SDK å°šæœªè¼‰å…¥', 'error');
          return false;
        }
        
        const app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        log('âœ… Firebase åˆå§‹åŒ–æˆåŠŸ', 'success');
        return true;
      } catch (error) {
        log('âŒ Firebase åˆå§‹åŒ–å¤±æ•—ï¼š' + error.message, 'error');
        return false;
      }
    }

    // åˆå§‹åŒ– Supabase
    function initSupabase() {
      try {
        if (typeof supabase === 'undefined' || !window.supabase) {
          log('Supabase SDK å°šæœªè¼‰å…¥', 'error');
          return false;
        }
        
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        log('âœ… Supabase åˆå§‹åŒ–æˆåŠŸ', 'success');
        return true;
      } catch (error) {
        log('âŒ Supabase åˆå§‹åŒ–å¤±æ•—ï¼š' + error.message, 'error');
        return false;
      }
    }

    // ä½¿ç”¨æ–‡å¿ƒ AI åˆ¤å®šå­¸æ ¡ç§‘ç³»
    async function getMajorsFromAI(university) {
      if (!supabase) {
        if (!initSupabase()) {
          throw new Error('Supabase æœªåˆå§‹åŒ–');
        }
      }

      // æ§‹å»ºæç¤ºè©
      const prompt = `è«‹æ ¹æ“šä»¥ä¸‹å¤§å­¸è³‡è¨Šï¼Œåˆ¤å®šé€™æ‰€å¤§å­¸æ‡‰è©²æœ‰å“ªäº›ç§‘ç³»ã€‚è«‹è¿”å› JSON æ ¼å¼çš„ç§‘ç³»åˆ—è¡¨ï¼Œæ¯å€‹ç§‘ç³»åŒ…å« nameï¼ˆç§‘ç³»åç¨±ï¼‰å’Œ admission_scoreï¼ˆéŒ„å–åˆ†æ•¸ï¼Œ0-100ï¼‰å…©å€‹æ¬„ä½ã€‚

å¤§å­¸è³‡è¨Šï¼š
- åç¨±ï¼š${university.name || 'æœªçŸ¥'}${university.nameEn ? ` (${university.nameEn})` : ''}
- é¡å‹ï¼š${university.type || 'æœªçŸ¥'}
- åœ°å€ï¼š${university.city || university.district || 'æœªçŸ¥'}
${university.description ? `- æè¿°ï¼š${university.description}` : ''}

è«‹æ ¹æ“šé€™æ‰€å¤§å­¸çš„å¯¦éš›æƒ…æ³ï¼ˆåç¨±ã€é¡å‹ã€åœ°å€ã€ç‰¹è‰²ç­‰ï¼‰ï¼Œç”Ÿæˆ 15-30 å€‹æœ€é©åˆçš„ç§‘ç³»ã€‚ç§‘ç³»æ‡‰è©²ç¬¦åˆè©²å¤§å­¸çš„å®šä½å’Œç‰¹è‰²ã€‚

è«‹åªè¿”å› JSON é™£åˆ—æ ¼å¼ï¼Œä¾‹å¦‚ï¼š
[
  {"name": "è³‡è¨Šå·¥ç¨‹å­¸ç³»", "admission_score": 70},
  {"name": "ä¼æ¥­ç®¡ç†å­¸ç³»", "admission_score": 65}
]

ä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—èªªæ˜ï¼Œåªè¿”å› JSON é™£åˆ—ã€‚`;

      log(`ğŸ¤– æ­£åœ¨ä½¿ç”¨ AI åˆ¤å®šã€Œ${university.name}ã€çš„ç§‘ç³»...`, 'info');

      try {
        const { data, error } = await supabase.functions.invoke('ask-ai', {
          body: {
            prompt: prompt,
            history: []
          }
        });

        if (error) {
          throw new Error(`AI èª¿ç”¨å¤±æ•—ï¼š${error.message || JSON.stringify(error)}`);
        }

        if (!data || !data.response) {
          throw new Error('AI æœªè¿”å›æœ‰æ•ˆå›æ‡‰');
        }

        // è§£æ AI å›æ‡‰
        let responseText = data.response.trim();
        
        // å˜—è©¦æå– JSONï¼ˆå¯èƒ½åŒ…å«åœ¨ markdown ä»£ç¢¼å¡Šä¸­ï¼‰
        const jsonMatch = responseText.match(/\[[\s\S]*\]/);
        if (jsonMatch) {
          responseText = jsonMatch[0];
        }

        // è§£æ JSON
        const majors = JSON.parse(responseText);
        
        if (!Array.isArray(majors)) {
          throw new Error('AI è¿”å›çš„æ ¼å¼ä¸æ˜¯é™£åˆ—');
        }

        // é©—è­‰æ¯å€‹ç§‘ç³»çš„æ ¼å¼
        const validMajors = majors.filter(major => {
          return major && typeof major === 'object' && 
                 major.name && typeof major.name === 'string' &&
                 typeof major.admission_score === 'number';
        });

        if (validMajors.length === 0) {
          throw new Error('AI è¿”å›çš„ç§‘ç³»æ ¼å¼ä¸æ­£ç¢º');
        }

        log(`âœ… AI åˆ¤å®šå®Œæˆï¼Œå…± ${validMajors.length} å€‹ç§‘ç³»`, 'success');
        return validMajors;

      } catch (error) {
        log(`âŒ AI åˆ¤å®šå¤±æ•—ï¼š${error.message}`, 'error');
        console.error('AI åˆ¤å®šéŒ¯èª¤è©³æƒ…ï¼š', error);
        throw error;
      }
    }

    // æ—¥èªŒåŠŸèƒ½
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString('zh-TW');
      entry.textContent = `[${timestamp}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    // æª¢æŸ¥IDæ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦
    function containsChinese(str) {
      if (!str) return false;
      // æª¢æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼ˆåŒ…æ‹¬ä¸­æ–‡æ¨™é»ç¬¦è™Ÿï¼‰
      return /[\u4e00-\u9fa5\u3400-\u4dbf\uf900-\ufaff]/.test(str);
    }

    // æª¢æŸ¥æ‰€æœ‰å¤§å­¸
    async function checkUniversities() {
      if (!db && !initFirebase()) {
        return;
      }

      log('é–‹å§‹æª¢æŸ¥å¤§å­¸è³‡æ–™...', 'info');
      
      try {
        const snapshot = await db.collection('universities').get();
        universities = [];
        let skippedCount = 0;
        
        snapshot.forEach(doc => {
          // è·³éä¸­æ–‡IDçš„è¨˜éŒ„
          if (containsChinese(doc.id)) {
            skippedCount++;
            return;
          }
          
          const data = doc.data();
          const majors = data.majors || [];
          universities.push({
            id: doc.id,
            name: data.name || 'æœªçŸ¥å¤§å­¸',
            type: data.type || 'æœªçŸ¥é¡å‹',
            majors: majors,
            hasMajors: majors.length > 0
          });
        });

        if (skippedCount > 0) {
          log(`âš ï¸ å·²è·³é ${skippedCount} ç­†ä¸­æ–‡IDçš„è¨˜éŒ„`, 'warning');
        }

        log(`âœ… æˆåŠŸè¼‰å…¥ ${universities.length} ç­†å¤§å­¸è³‡æ–™`, 'success');
        
        updateStats();
        displayUniversities();
        
      } catch (error) {
        log('âŒ æª¢æŸ¥å¤±æ•—ï¼š' + error.message, 'error');
        console.error(error);
      }
    }

    // æ›´æ–°çµ±è¨ˆè³‡è¨Š
    function updateStats() {
      const total = universities.length;
      const noMajors = universities.filter(u => !u.hasMajors).length;
      const hasMajors = universities.filter(u => u.hasMajors).length;

      document.getElementById('total-universities').textContent = total;
      document.getElementById('no-majors-count').textContent = noMajors;
      document.getElementById('has-majors-count').textContent = hasMajors;
    }

    // é¡¯ç¤ºå¤§å­¸åˆ—è¡¨
    function displayUniversities() {
      const listDiv = document.getElementById('university-list');
      listDiv.style.display = 'block';
      listDiv.innerHTML = '';

      universities.forEach(uni => {
        const item = document.createElement('div');
        item.className = `university-item ${uni.hasMajors ? 'has-majors' : 'no-majors'}`;
        
        item.innerHTML = `
          <div class="university-info">
            <div class="university-name">${uni.name}</div>
            <div class="university-details">é¡å‹: ${uni.type} | ID: ${uni.id}</div>
          </div>
          <div style="display: flex; align-items: center;">
            <span class="majors-count ${uni.hasMajors ? '' : 'zero'}">
              ${uni.majors.length} å€‹ç§‘ç³»
            </span>
            ${!uni.hasMajors ? `<button class="button" onclick="addMajorsToUniversity('${uni.id}', '${uni.name.replace(/'/g, "\\'")}')">æ·»åŠ ç§‘ç³»</button>` : ''}
          </div>
        `;
        
        listDiv.appendChild(item);
      });
    }

    // ç‚ºå–®ä¸€å¤§å­¸æ·»åŠ ç§‘ç³»ï¼ˆä½¿ç”¨ AIï¼‰
    async function addMajorsToUniversity(universityId, universityName) {
      if (!db) {
        log('Firebase å°šæœªåˆå§‹åŒ–', 'error');
        return;
      }

      // æª¢æŸ¥IDæ˜¯å¦åŒ…å«ä¸­æ–‡
      if (containsChinese(universityId)) {
        log(`âš ï¸ è·³éä¸­æ–‡IDçš„è¨˜éŒ„ï¼š${universityId}`, 'warning');
        return;
      }

      // ç²å–å®Œæ•´çš„å¤§å­¸è³‡è¨Š
      const university = universities.find(u => u.id === universityId);
      if (!university) {
        log(`æ‰¾ä¸åˆ°å¤§å­¸ï¼š${universityName}`, 'error');
        return;
      }

      // å¾ Firebase ç²å–å®Œæ•´è³‡è¨Š
      try {
        const doc = await db.collection('universities').doc(universityId).get();
        if (doc.exists) {
          const data = doc.data();
          university.name = data.name || university.name;
          university.nameEn = data.nameEn || '';
          university.type = data.type || university.type;
          university.city = data.city || '';
          university.district = data.district || '';
          university.description = data.description || '';
        }
      } catch (error) {
        log(`âš ï¸ ç„¡æ³•ç²å–å®Œæ•´å¤§å­¸è³‡è¨Šï¼š${error.message}`, 'warning');
      }

      log(`é–‹å§‹ç‚ºã€Œ${universityName}ã€ä½¿ç”¨ AI åˆ¤å®šç§‘ç³»...`, 'info');

      try {
        // ä½¿ç”¨ AI åˆ¤å®šç§‘ç³»
        const majors = await getMajorsFromAI(university);

        // ä¿å­˜åˆ° Firebase
        await db.collection('universities').doc(universityId).update({
          majors: majors
        });

        log(`âœ… æˆåŠŸç‚ºã€Œ${universityName}ã€æ·»åŠ  ${majors.length} å€‹ç§‘ç³»`, 'success');
        
        // é‡æ–°æª¢æŸ¥
        await checkUniversities();
        
      } catch (error) {
        log(`âŒ ç‚ºã€Œ${universityName}ã€æ·»åŠ ç§‘ç³»å¤±æ•—ï¼š${error.message}`, 'error');
        console.error(error);
      }
    }

    // ç‚ºæ‰€æœ‰ç¼ºå°‘ç§‘ç³»çš„å¤§å­¸æ·»åŠ ç§‘ç³»ï¼ˆä½¿ç”¨ AIï¼‰
    async function addMajorsToAll() {
      if (!db && !initFirebase()) {
        return;
      }

      if (!supabase && !initSupabase()) {
        log('âŒ Supabase åˆå§‹åŒ–å¤±æ•—ï¼Œç„¡æ³•ä½¿ç”¨ AI åŠŸèƒ½', 'error');
        return;
      }

      // å…ˆæª¢æŸ¥
      if (universities.length === 0) {
        await checkUniversities();
      }

      const noMajorsUnis = universities.filter(u => !u.hasMajors);
      
      if (noMajorsUnis.length === 0) {
        log('âœ… æ‰€æœ‰å¤§å­¸éƒ½å·²æœ‰ç§‘ç³»è³‡æ–™', 'success');
        return;
      }

      const confirmMsg = `ç¢ºå®šè¦ä½¿ç”¨ AI ç‚º ${noMajorsUnis.length} æ‰€å¤§å­¸æ™ºèƒ½åˆ¤å®šä¸¦æ·»åŠ ç§‘ç³»å—ï¼Ÿ\n\né€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ï¼Œå› ç‚ºæ¯æ‰€å¤§å­¸éƒ½éœ€è¦ AI åˆ†æã€‚`;
      if (!confirm(confirmMsg)) {
        return;
      }

      log(`é–‹å§‹ä½¿ç”¨ AI ç‚º ${noMajorsUnis.length} æ‰€å¤§å­¸åˆ¤å®šç§‘ç³»...`, 'info');
      log('â³ é€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ™‚é–“ï¼Œè«‹è€å¿ƒç­‰å¾…...', 'warning');

      let successCount = 0;
      let failCount = 0;

      for (let i = 0; i < noMajorsUnis.length; i++) {
        const uni = noMajorsUnis[i];
        
        try {
          // ç²å–å®Œæ•´çš„å¤§å­¸è³‡è¨Š
          const doc = await db.collection('universities').doc(uni.id).get();
          if (doc.exists) {
            const data = doc.data();
            uni.name = data.name || uni.name;
            uni.nameEn = data.nameEn || '';
            uni.type = data.type || uni.type;
            uni.city = data.city || '';
            uni.district = data.district || '';
            uni.description = data.description || '';
          }

          log(`[${i + 1}/${noMajorsUnis.length}] æ­£åœ¨è™•ç†ï¼š${uni.name}...`, 'info');

          // ä½¿ç”¨ AI åˆ¤å®šç§‘ç³»
          const majors = await getMajorsFromAI(uni);

          // ä¿å­˜åˆ° Firebase
          await db.collection('universities').doc(uni.id).update({
            majors: majors
          });

          log(`âœ… ${uni.name} - æˆåŠŸæ·»åŠ  ${majors.length} å€‹ç§‘ç³»`, 'success');
          successCount++;

          // æ·»åŠ å»¶é²ï¼Œé¿å… API èª¿ç”¨éæ–¼é »ç¹
          if (i < noMajorsUnis.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 1000));
          }

        } catch (error) {
          log(`âŒ ${uni.name} - æ·»åŠ å¤±æ•—ï¼š${error.message}`, 'error');
          failCount++;
        }
      }

      log(`\nğŸ“Š å®Œæˆï¼æˆåŠŸ: ${successCount}, å¤±æ•—: ${failCount}`, 'info');
      
      // é‡æ–°æª¢æŸ¥
      await checkUniversities();
    }

    // ä½¿ç”¨æ–‡å¿ƒ Web Search æœç´¢å¤§å­¸éŒ„å–åˆ†æ•¸
    async function searchAdmissionScoresWithAI(university, year) {
      if (!supabase) {
        if (!initSupabase()) {
          throw new Error('Supabase æœªåˆå§‹åŒ–');
        }
      }

      // æ§‹å»ºæœç´¢æç¤ºè©
      const searchQuery = `${university.name} ${year}å¹´ éŒ„å–åˆ†æ•¸ å„ç§‘ç³»`;
      const currentDate = new Date().toISOString().split('T')[0];
      
      // æ§‹å»ºç§‘ç³»åˆ—è¡¨
      let majorsListText = '';
      if (university.majors && university.majors.length > 0) {
        const majorNames = university.majors.map(m => m.name || m).filter(Boolean);
        majorsListText = `\n\nè©²å¤§å­¸çš„ç§‘ç³»åˆ—è¡¨ï¼ˆè«‹å„ªå…ˆæœç´¢é€™äº›ç§‘ç³»çš„éŒ„å–åˆ†æ•¸ï¼‰ï¼š\n${majorNames.map((name, idx) => `${idx + 1}. ${name}`).join('\n')}\n\nè«‹é‡é»æœç´¢ä»¥ä¸Šç§‘ç³»çš„éŒ„å–åˆ†æ•¸ã€‚å¦‚æœç¶²çµ¡æœç´¢çµæœä¸­åŒ…å«å…¶ä»–ç§‘ç³»çš„éŒ„å–åˆ†æ•¸ï¼Œä¹Ÿå¯ä»¥ä¸€ä½µåŒ…å«ã€‚`;
      } else {
        majorsListText = `\n\næ³¨æ„ï¼šè©²å¤§å­¸å°šæœªæœ‰å®Œæ•´çš„ç§‘ç³»åˆ—è¡¨ã€‚è«‹æœç´¢è©²å¤§å­¸åœ¨ ${year} å¹´æ‰€æœ‰å¸¸è¦‹ç§‘ç³»çš„éŒ„å–åˆ†æ•¸ï¼ŒåŒ…æ‹¬ä½†ä¸é™æ–¼ï¼š\n- è©²å¤§å­¸é¡å‹ï¼ˆ${university.type || 'æœªçŸ¥'}ï¼‰å¸¸è¦‹çš„ç§‘ç³»\n- è©²å¤§å­¸æ‰€åœ¨åœ°å€å¸¸è¦‹çš„ç§‘ç³»\n- è©²å¤§å­¸çš„ç‰¹è‰²ç§‘ç³»\n\nè«‹ç›¡å¯èƒ½æœç´¢åˆ°æ›´å¤šç§‘ç³»çš„éŒ„å–åˆ†æ•¸ã€‚`;
      }

      const prompt = `è«‹ä½¿ç”¨ç¶²çµ¡æœç´¢åŠŸèƒ½æŸ¥æ‰¾ä»¥ä¸‹å¤§å­¸åœ¨æŒ‡å®šå¹´ä»½çš„éŒ„å–åˆ†æ•¸è³‡è¨Šã€‚è«‹æœç´¢æœ€æ–°çš„ã€æº–ç¢ºçš„éŒ„å–åˆ†æ•¸æ•¸æ“šã€‚

å¤§å­¸è³‡è¨Šï¼š
- åç¨±ï¼š${university.name}${university.nameEn ? ` (${university.nameEn})` : ''}
- é¡å‹ï¼š${university.type || 'æœªçŸ¥'}
- åœ°å€ï¼š${university.city || university.district || 'æœªçŸ¥'}
- ç›®æ¨™å¹´ä»½ï¼š${year}å¹´${majorsListText}

è«‹æœç´¢è©²å¤§å­¸åœ¨ ${year} å¹´å„ç§‘ç³»çš„éŒ„å–åˆ†æ•¸è³‡è¨Šï¼ŒåŒ…æ‹¬ï¼š
1. æœ€ä½éŒ„å–åˆ†æ•¸ï¼ˆmin_scoreï¼‰
2. å¹³å‡éŒ„å–åˆ†æ•¸ï¼ˆavg_scoreï¼Œå¦‚æœæœ‰ï¼‰
3. æœ€é«˜éŒ„å–åˆ†æ•¸ï¼ˆmax_scoreï¼Œå¦‚æœæœ‰ï¼‰

è«‹å¾å¯é çš„å®˜æ–¹ä¾†æºæˆ–æ•™è‚²ç¶²ç«™ç²å–æ•¸æ“šï¼Œä¸¦è¿”å› JSON æ ¼å¼çš„çµæœã€‚

è¿”å›æ ¼å¼å¿…é ˆåš´æ ¼éµå¾ªä»¥ä¸‹ JSON çµæ§‹ï¼š
{
  "year": ${year},
  "university": "${university.name}",
  "scores": [
    {
      "major": "ç§‘ç³»å®Œæ•´åç¨±",
      "min_score": æ•¸å­—ï¼ˆæœ€ä½éŒ„å–åˆ†æ•¸ï¼Œå¿…å¡«ï¼‰,
      "avg_score": æ•¸å­—æˆ–nullï¼ˆå¹³å‡éŒ„å–åˆ†æ•¸ï¼Œå¯é¸ï¼‰,
      "max_score": æ•¸å­—æˆ–nullï¼ˆæœ€é«˜éŒ„å–åˆ†æ•¸ï¼Œå¯é¸ï¼‰
    }
  ],
  "source": "æ•¸æ“šä¾†æºç¶²å€æˆ–èªªæ˜",
  "search_date": "${currentDate}"
}

é‡è¦è¦æ±‚ï¼š
1. åªè¿”å›æœ‰æ•ˆçš„ JSON æ ¼å¼ï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—
2. å¦‚æœæ‰¾ä¸åˆ°å…·é«”åˆ†æ•¸ï¼Œscores æ‡‰ç‚ºç©ºé™£åˆ— []
3. min_score å¿…é ˆæ˜¯æ•¸å­—ï¼Œä¸èƒ½ç‚º null
4. è«‹ç¢ºä¿ç§‘ç³»åç¨±æº–ç¢ºå®Œæ•´
5. å¦‚æœæœç´¢åˆ°å¤šå€‹ç§‘ç³»ï¼Œè«‹å…¨éƒ¨åŒ…å«åœ¨ scores é™£åˆ—ä¸­

è«‹é–‹å§‹æœç´¢ä¸¦è¿”å›çµæœã€‚`;

      log(`ğŸ” æ­£åœ¨æœç´¢ã€Œ${university.name}ã€${year}å¹´çš„éŒ„å–åˆ†æ•¸...`, 'info');

      try {
        // èª¿ç”¨æ–‡å¿ƒ AIï¼ˆä½¿ç”¨ web_search åŠŸèƒ½ï¼‰
        const { data, error } = await supabase.functions.invoke('ask-ai', {
          body: {
            prompt: prompt,
            history: [],
            use_web_search: true  // å•Ÿç”¨ Web Search
          }
        });

        if (error) {
          throw new Error(`æœç´¢å¤±æ•—ï¼š${error.message || JSON.stringify(error)}`);
        }

        if (!data || !data.response) {
          throw new Error('AI æœªè¿”å›æœ‰æ•ˆå›æ‡‰');
        }

        // è§£æ AI å›æ‡‰
        let responseText = data.response.trim();
        
        // è¨˜éŒ„åŸå§‹å›æ‡‰ï¼ˆç”¨æ–¼èª¿è©¦ï¼‰
        console.log('AI åŸå§‹å›æ‡‰ï¼š', responseText);
        
        // å˜—è©¦æå– JSONï¼ˆå¯èƒ½åŒ…å«åœ¨ markdown ä»£ç¢¼å¡Šä¸­ï¼‰
        const jsonMatch = responseText.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          responseText = jsonMatch[0];
        } else {
          // å¦‚æœæ²’æœ‰æ‰¾åˆ° JSONï¼Œå˜—è©¦æŸ¥æ‰¾ä»£ç¢¼å¡Š
          const codeBlockMatch = responseText.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);
          if (codeBlockMatch) {
            responseText = codeBlockMatch[1];
          }
        }

        // è§£æ JSON
        let result;
        try {
          result = JSON.parse(responseText);
        } catch (parseError) {
          log(`âš ï¸ JSON è§£æå¤±æ•—ï¼Œå˜—è©¦æ¸…ç†æ ¼å¼...`, 'warning');
          console.error('è§£æéŒ¯èª¤ï¼š', parseError);
          console.error('å˜—è©¦è§£æçš„æ–‡å­—ï¼š', responseText);
          throw new Error(`ç„¡æ³•è§£æ AI å›æ‡‰ç‚º JSONï¼š${parseError.message}`);
        }
        
        if (!result || !result.scores || !Array.isArray(result.scores)) {
          log(`âš ï¸ AI è¿”å›æ ¼å¼ï¼š`, 'warning');
          console.log('AI è¿”å›çš„å®Œæ•´çµæœï¼š', result);
          throw new Error('AI è¿”å›çš„æ ¼å¼ä¸æ­£ç¢ºï¼šç¼ºå°‘ scores é™£åˆ—');
        }

        if (result.scores.length === 0) {
          log(`âš ï¸ æœç´¢å®Œæˆï¼Œä½†æœªæ‰¾åˆ°ä»»ä½•ç§‘ç³»çš„éŒ„å–åˆ†æ•¸`, 'warning');
          log(`ğŸ’¡ å¯èƒ½åŸå› ï¼š1) ${year}å¹´çš„éŒ„å–åˆ†æ•¸å°šæœªå…¬å¸ƒ 2) ç¶²çµ¡æœç´¢æœªæ‰¾åˆ°ç›¸é—œæ•¸æ“š 3) è©²å¤§å­¸å¯èƒ½æ²’æœ‰å…¬é–‹éŒ„å–åˆ†æ•¸`, 'info');
        } else {
          log(`âœ… æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${result.scores.length} å€‹ç§‘ç³»çš„éŒ„å–åˆ†æ•¸`, 'success');
        }
        
        return result;

      } catch (error) {
        log(`âŒ æœç´¢å¤±æ•—ï¼š${error.message}`, 'error');
        console.error('æœç´¢éŒ¯èª¤è©³æƒ…ï¼š', error);
        throw error;
      }
    }

    // ä¿å­˜éŒ„å–åˆ†æ•¸åˆ° Firebase
    async function saveAdmissionScoresToFirebase(universityId, year, scoresData) {
      if (!db) {
        throw new Error('Firebase å°šæœªåˆå§‹åŒ–');
      }

      try {
        const universityRef = db.collection('universities').doc(universityId);
        const universityDoc = await universityRef.get();

        if (!universityDoc.exists) {
          throw new Error('å¤§å­¸æ–‡æª”ä¸å­˜åœ¨');
        }

        // ç²å–ç¾æœ‰çš„ admission_scores æ•¸æ“š
        const currentData = universityDoc.data();
        let admissionScores = currentData.admission_scores || {};

        // æ›´æ–°æŒ‡å®šå¹´ä»½çš„éŒ„å–åˆ†æ•¸
        admissionScores[year] = {
          year: parseInt(year),
          scores: scoresData.scores || [],
          source: scoresData.source || 'æ–‡å¿ƒ Web Search',
          search_date: scoresData.search_date || new Date().toISOString(),
          updated_at: new Date().toISOString()
        };

        // ä¿å­˜åˆ° Firebase
        await universityRef.update({
          admission_scores: admissionScores
        });

        log(`âœ… å·²ä¿å­˜ ${year} å¹´çš„éŒ„å–åˆ†æ•¸åˆ° Firebase`, 'success');
        return true;

      } catch (error) {
        log(`âŒ ä¿å­˜å¤±æ•—ï¼š${error.message}`, 'error');
        throw error;
      }
    }

    // ç‚ºå–®ä¸€å¤§å­¸æœç´¢éŒ„å–åˆ†æ•¸
    async function searchAdmissionScoresForUniversity(universityId, year) {
      if (!db) {
        log('Firebase å°šæœªåˆå§‹åŒ–', 'error');
        return;
      }

      // æª¢æŸ¥IDæ˜¯å¦åŒ…å«ä¸­æ–‡
      if (containsChinese(universityId)) {
        log(`âš ï¸ è·³éä¸­æ–‡IDçš„è¨˜éŒ„ï¼š${universityId}`, 'warning');
        return;
      }

      const university = universities.find(u => u.id === universityId);
      if (!university) {
        log(`æ‰¾ä¸åˆ°å¤§å­¸ ID: ${universityId}`, 'error');
        return;
      }

      // å¾ Firebase ç²å–å®Œæ•´è³‡è¨Š
      try {
        const doc = await db.collection('universities').doc(universityId).get();
        if (doc.exists) {
          const data = doc.data();
          university.name = data.name || university.name;
          university.nameEn = data.nameEn || '';
          university.type = data.type || university.type;
          university.city = data.city || '';
          university.district = data.district || '';
          university.majors = data.majors || [];
          university.description = data.description || '';
        }
      } catch (error) {
        log(`âš ï¸ ç„¡æ³•ç²å–å®Œæ•´å¤§å­¸è³‡è¨Šï¼š${error.message}`, 'warning');
      }

      // æª¢æŸ¥æ˜¯å¦æœ‰ç§‘ç³»æ•¸æ“š
      if (!university.majors || university.majors.length === 0) {
        log(`âš ï¸ ã€Œ${university.name}ã€å°šæœªæœ‰ç§‘ç³»æ•¸æ“šï¼Œå°‡æœç´¢è©²å¤§å­¸æ‰€æœ‰å¸¸è¦‹ç§‘ç³»çš„éŒ„å–åˆ†æ•¸`, 'warning');
      } else {
        log(`ğŸ“‹ ã€Œ${university.name}ã€å…±æœ‰ ${university.majors.length} å€‹ç§‘ç³»ï¼Œå°‡æœç´¢é€™äº›ç§‘ç³»çš„éŒ„å–åˆ†æ•¸`, 'info');
      }

      log(`é–‹å§‹ç‚ºã€Œ${university.name}ã€æœç´¢ ${year} å¹´çš„éŒ„å–åˆ†æ•¸...`, 'info');

      try {
        // ä½¿ç”¨ AI æœç´¢éŒ„å–åˆ†æ•¸
        const scoresData = await searchAdmissionScoresWithAI(university, year);

        // ä¿å­˜åˆ° Firebase
        await saveAdmissionScoresToFirebase(universityId, year, scoresData);

        log(`âœ… æˆåŠŸç‚ºã€Œ${university.name}ã€ä¿å­˜ ${scoresData.scores.length} å€‹ç§‘ç³»çš„éŒ„å–åˆ†æ•¸`, 'success');
        
        return scoresData;

      } catch (error) {
        log(`âŒ ç‚ºã€Œ${university.name}ã€æœç´¢éŒ„å–åˆ†æ•¸å¤±æ•—ï¼š${error.message}`, 'error');
        console.error(error);
        throw error;
      }
    }

    // æœç´¢æ‰€æœ‰å¤§å­¸çš„éŒ„å–åˆ†æ•¸
    async function searchAdmissionScoresForAll() {
      if (!db && !initFirebase()) {
        return;
      }

      if (!supabase && !initSupabase()) {
        log('âŒ Supabase åˆå§‹åŒ–å¤±æ•—ï¼Œç„¡æ³•ä½¿ç”¨æœç´¢åŠŸèƒ½', 'error');
        return;
      }

      // å…ˆæª¢æŸ¥
      if (universities.length === 0) {
        await checkUniversities();
      }

      const year = document.getElementById('search-year').value;
      
      if (!year) {
        log('âŒ è«‹é¸æ“‡å¹´ä»½', 'error');
        return;
      }

      const confirmMsg = `ç¢ºå®šè¦ç‚ºæ‰€æœ‰ ${universities.length} æ‰€å¤§å­¸æœç´¢ ${year} å¹´çš„éŒ„å–åˆ†æ•¸å—ï¼Ÿ\n\né€™å¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“ï¼Œå› ç‚ºæ¯æ‰€å¤§å­¸éƒ½éœ€è¦æœç´¢ã€‚`;
      if (!confirm(confirmMsg)) {
        return;
      }

      log(`é–‹å§‹ç‚ºæ‰€æœ‰å¤§å­¸æœç´¢ ${year} å¹´çš„éŒ„å–åˆ†æ•¸...`, 'info');
      log('â³ é€™å¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“ï¼Œè«‹è€å¿ƒç­‰å¾…...', 'warning');

      let successCount = 0;
      let failCount = 0;

      for (let i = 0; i < universities.length; i++) {
        const uni = universities[i];
        
        try {
          log(`[${i + 1}/${universities.length}] æ­£åœ¨è™•ç†ï¼š${uni.name}...`, 'info');
          
          // æª¢æŸ¥æ˜¯å¦æœ‰ç§‘ç³»æ•¸æ“š
          if (!uni.majors || uni.majors.length === 0) {
            log(`âš ï¸ ${uni.name} å°šæœªæœ‰ç§‘ç³»æ•¸æ“šï¼Œå°‡å˜—è©¦æœç´¢è©²å¤§å­¸æ‰€æœ‰å¸¸è¦‹ç§‘ç³»`, 'warning');
          }

          await searchAdmissionScoresForUniversity(uni.id, year);
          successCount++;

          // æ·»åŠ å»¶é²ï¼Œé¿å… API èª¿ç”¨éæ–¼é »ç¹
          if (i < universities.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 2000)); // 2ç§’å»¶é²
          }

        } catch (error) {
          log(`âŒ ${uni.name} - æœç´¢å¤±æ•—ï¼š${error.message}`, 'error');
          failCount++;
        }
      }

      log(`\nğŸ“Š å®Œæˆï¼æˆåŠŸ: ${successCount}, å¤±æ•—: ${failCount}`, 'info');
    }

    // æœç´¢é¸ä¸­å¤§å­¸çš„éŒ„å–åˆ†æ•¸ï¼ˆéœ€è¦å…ˆå¯¦ç¾é¸æ“‡åŠŸèƒ½ï¼‰
    async function searchAdmissionScoresForSelected() {
      log('âš ï¸ æ­¤åŠŸèƒ½éœ€è¦å…ˆé¸æ“‡å¤§å­¸ï¼Œè«‹ä½¿ç”¨ã€Œæœç´¢æ‰€æœ‰å¤§å­¸çš„éŒ„å–åˆ†æ•¸ã€åŠŸèƒ½', 'warning');
      // æœªä¾†å¯ä»¥æ“´å±•ç‚ºæ”¯æŒé¸æ“‡ç‰¹å®šå¤§å­¸
    }

    // ========== æŸ¥çœ‹å’Œç®¡ç†éŒ„å–åˆ†æ•¸åŠŸèƒ½ ==========
    
    // è¼‰å…¥æ‰€æœ‰éŒ„å–åˆ†æ•¸
    async function loadAllAdmissionScores() {
      if (!db && !initFirebase()) {
        return;
      }

      log('é–‹å§‹è¼‰å…¥æ‰€æœ‰éŒ„å–åˆ†æ•¸...', 'info');
      
      try {
        const snapshot = await db.collection('universities').get();
        const scoresData = [];
        let skippedCount = 0;

        snapshot.forEach(doc => {
          // è·³éä¸­æ–‡IDçš„è¨˜éŒ„
          if (containsChinese(doc.id)) {
            skippedCount++;
            return;
          }
          
          const data = doc.data();
          const admissionScores = data.admission_scores || {};
          
          // éæ­·æ‰€æœ‰å¹´ä»½çš„éŒ„å–åˆ†æ•¸
          Object.keys(admissionScores).forEach(year => {
            const yearData = admissionScores[year];
            if (yearData && yearData.scores && Array.isArray(yearData.scores)) {
              yearData.scores.forEach(score => {
                scoresData.push({
                  universityId: doc.id,
                  universityName: data.name || 'æœªçŸ¥å¤§å­¸',
                  year: year,
                  major: score.major || 'æœªçŸ¥ç§‘ç³»',
                  minScore: score.min_score || null,
                  avgScore: score.avg_score || null,
                  maxScore: score.max_score || null,
                  source: yearData.source || 'æœªçŸ¥ä¾†æº',
                  searchDate: yearData.search_date || 'æœªçŸ¥æ—¥æœŸ'
                });
              });
            }
          });
        });

        if (skippedCount > 0) {
          log(`âš ï¸ å·²è·³é ${skippedCount} ç­†ä¸­æ–‡IDçš„è¨˜éŒ„`, 'warning');
        }

        log(`âœ… æˆåŠŸè¼‰å…¥ ${scoresData.length} ç­†éŒ„å–åˆ†æ•¸æ•¸æ“š`, 'success');
        displayAdmissionScores(scoresData);
        
      } catch (error) {
        log('âŒ è¼‰å…¥å¤±æ•—ï¼š' + error.message, 'error');
        console.error(error);
      }
    }

    // æŒ‰å¹´ä»½æŸ¥çœ‹éŒ„å–åˆ†æ•¸
    async function viewAdmissionScoresByYear() {
      if (!db && !initFirebase()) {
        return;
      }

      const year = prompt('è«‹è¼¸å…¥è¦æŸ¥çœ‹çš„å¹´ä»½ï¼ˆä¾‹å¦‚ï¼š2024ï¼‰ï¼š');
      if (!year) return;

      log(`é–‹å§‹è¼‰å…¥ ${year} å¹´çš„éŒ„å–åˆ†æ•¸...`, 'info');
      
      try {
        const snapshot = await db.collection('universities').get();
        const scoresData = [];
        let skippedCount = 0;

        snapshot.forEach(doc => {
          // è·³éä¸­æ–‡IDçš„è¨˜éŒ„
          if (containsChinese(doc.id)) {
            skippedCount++;
            return;
          }
          
          const data = doc.data();
          const admissionScores = data.admission_scores || {};
          const yearData = admissionScores[year];
          
          if (yearData && yearData.scores && Array.isArray(yearData.scores)) {
            yearData.scores.forEach(score => {
              scoresData.push({
                universityId: doc.id,
                universityName: data.name || 'æœªçŸ¥å¤§å­¸',
                year: year,
                major: score.major || 'æœªçŸ¥ç§‘ç³»',
                minScore: score.min_score || null,
                avgScore: score.avg_score || null,
                maxScore: score.max_score || null,
                source: yearData.source || 'æœªçŸ¥ä¾†æº',
                searchDate: yearData.search_date || 'æœªçŸ¥æ—¥æœŸ'
              });
            });
          }
        });

        if (skippedCount > 0) {
          log(`âš ï¸ å·²è·³é ${skippedCount} ç­†ä¸­æ–‡IDçš„è¨˜éŒ„`, 'warning');
        }

        if (scoresData.length === 0) {
          log(`âš ï¸ ${year} å¹´æ²’æœ‰æ‰¾åˆ°ä»»ä½•éŒ„å–åˆ†æ•¸æ•¸æ“š`, 'warning');
        } else {
          log(`âœ… æˆåŠŸè¼‰å…¥ ${scoresData.length} ç­† ${year} å¹´çš„éŒ„å–åˆ†æ•¸`, 'success');
        }
        
        displayAdmissionScores(scoresData);
        
      } catch (error) {
        log('âŒ è¼‰å…¥å¤±æ•—ï¼š' + error.message, 'error');
        console.error(error);
      }
    }

    // æŒ‰å¤§å­¸æŸ¥çœ‹éŒ„å–åˆ†æ•¸
    async function viewAdmissionScoresByUniversity() {
      if (!db && !initFirebase()) {
        return;
      }

      // å…ˆè¼‰å…¥å¤§å­¸åˆ—è¡¨
      if (universities.length === 0) {
        await checkUniversities();
      }

      if (universities.length === 0) {
        log('âŒ æ²’æœ‰æ‰¾åˆ°ä»»ä½•å¤§å­¸è³‡æ–™', 'error');
        return;
      }

      // å‰µå»ºé¸æ“‡å°è©±æ¡†
      const universityNames = universities.map(u => u.name).join('\n');
      const selectedName = prompt(`è«‹è¼¸å…¥è¦æŸ¥çœ‹çš„å¤§å­¸åç¨±ï¼š\n\nå¯ç”¨å¤§å­¸ï¼š\n${universityNames}`);
      
      if (!selectedName) return;

      const university = universities.find(u => u.name === selectedName || u.name.includes(selectedName));
      
      if (!university) {
        log(`âŒ æ‰¾ä¸åˆ°åç‚ºã€Œ${selectedName}ã€çš„å¤§å­¸`, 'error');
        return;
      }

      log(`é–‹å§‹è¼‰å…¥ã€Œ${university.name}ã€çš„éŒ„å–åˆ†æ•¸...`, 'info');
      
      try {
        const doc = await db.collection('universities').doc(university.id).get();
        
        if (!doc.exists) {
          log(`âŒ æ‰¾ä¸åˆ°å¤§å­¸è³‡æ–™`, 'error');
          return;
        }

        const data = doc.data();
        const admissionScores = data.admission_scores || {};
        const scoresData = [];

        // éæ­·æ‰€æœ‰å¹´ä»½
        Object.keys(admissionScores).forEach(year => {
          const yearData = admissionScores[year];
          if (yearData && yearData.scores && Array.isArray(yearData.scores)) {
            yearData.scores.forEach(score => {
              scoresData.push({
                universityId: university.id,
                universityName: university.name,
                year: year,
                major: score.major || 'æœªçŸ¥ç§‘ç³»',
                minScore: score.min_score || null,
                avgScore: score.avg_score || null,
                maxScore: score.max_score || null,
                source: yearData.source || 'æœªçŸ¥ä¾†æº',
                searchDate: yearData.search_date || 'æœªçŸ¥æ—¥æœŸ'
              });
            });
          }
        });

        if (scoresData.length === 0) {
          log(`âš ï¸ ã€Œ${university.name}ã€æ²’æœ‰æ‰¾åˆ°ä»»ä½•éŒ„å–åˆ†æ•¸æ•¸æ“š`, 'warning');
        } else {
          log(`âœ… æˆåŠŸè¼‰å…¥ã€Œ${university.name}ã€çš„ ${scoresData.length} ç­†éŒ„å–åˆ†æ•¸`, 'success');
        }
        
        displayAdmissionScores(scoresData);
        
      } catch (error) {
        log('âŒ è¼‰å…¥å¤±æ•—ï¼š' + error.message, 'error');
        console.error(error);
      }
    }

    // é¡¯ç¤ºéŒ„å–åˆ†æ•¸åˆ—è¡¨
    function displayAdmissionScores(scoresData) {
      const viewDiv = document.getElementById('admission-scores-view');
      const contentDiv = document.getElementById('admission-scores-content');
      
      if (!viewDiv || !contentDiv) return;

      viewDiv.style.display = 'block';
      contentDiv.innerHTML = '';

      if (scoresData.length === 0) {
        contentDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">æ²’æœ‰æ‰¾åˆ°ä»»ä½•éŒ„å–åˆ†æ•¸æ•¸æ“š</p>';
        return;
      }

      // æŒ‰å¤§å­¸å’Œå¹´ä»½åˆ†çµ„
      const grouped = {};
      scoresData.forEach(score => {
        const key = `${score.universityName}_${score.year}`;
        if (!grouped[key]) {
          grouped[key] = {
            universityName: score.universityName,
            year: score.year,
            scores: []
          };
        }
        grouped[key].scores.push(score);
      });

      // é¡¯ç¤ºåˆ†çµ„å¾Œçš„æ•¸æ“š
      Object.values(grouped).forEach(group => {
        const groupDiv = document.createElement('div');
        groupDiv.style.cssText = 'margin-bottom: 20px; padding: 15px; background: white; border: 1px solid #e0e0e0; border-radius: 8px;';
        
        groupDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">
            <h3 style="margin: 0; color: #333; font-size: 1.2em;">${group.universityName}</h3>
            <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9em;">${group.year}å¹´</span>
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px;">
        `;

        group.scores.forEach(score => {
          const scoreDiv = document.createElement('div');
          scoreDiv.style.cssText = 'padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #667eea;';
          
          let scoreText = `<strong>${score.major}</strong><br>`;
          if (score.minScore !== null) {
            scoreText += `æœ€ä½åˆ†ï¼š${score.minScore}`;
          }
          if (score.avgScore !== null) {
            scoreText += scoreText.includes('æœ€ä½åˆ†') ? ` | å¹³å‡åˆ†ï¼š${score.avgScore}` : `å¹³å‡åˆ†ï¼š${score.avgScore}`;
          }
          if (score.maxScore !== null) {
            scoreText += scoreText.includes('åˆ†') ? ` | æœ€é«˜åˆ†ï¼š${score.maxScore}` : `æœ€é«˜åˆ†ï¼š${score.maxScore}`;
          }
          if (!scoreText.includes('åˆ†')) {
            scoreText += 'æš«ç„¡åˆ†æ•¸æ•¸æ“š';
          }
          
          scoreDiv.innerHTML = scoreText;
          groupDiv.querySelector('div:last-child').appendChild(scoreDiv);
        });

        groupDiv.innerHTML += '</div>';
        contentDiv.appendChild(groupDiv);
      });

      log(`âœ… å·²é¡¯ç¤º ${scoresData.length} ç­†éŒ„å–åˆ†æ•¸æ•¸æ“š`, 'success');
    }

    // å°å‡ºéŒ„å–åˆ†æ•¸ç‚º JSON
    async function exportAdmissionScores() {
      if (!db && !initFirebase()) {
        return;
      }

      log('é–‹å§‹å°å‡ºéŒ„å–åˆ†æ•¸æ•¸æ“š...', 'info');
      
      try {
        const snapshot = await db.collection('universities').get();
        const exportData = {
          export_date: new Date().toISOString(),
          universities: []
        };
        let skippedCount = 0;

        snapshot.forEach(doc => {
          // è·³éä¸­æ–‡IDçš„è¨˜éŒ„
          if (containsChinese(doc.id)) {
            skippedCount++;
            return;
          }
          
          const data = doc.data();
          const admissionScores = data.admission_scores || {};
          
          if (Object.keys(admissionScores).length > 0) {
            exportData.universities.push({
              id: doc.id,
              name: data.name || 'æœªçŸ¥å¤§å­¸',
              nameEn: data.nameEn || '',
              type: data.type || '',
              city: data.city || '',
              admission_scores: admissionScores
            });
          }
        });

        if (skippedCount > 0) {
          log(`âš ï¸ å·²è·³é ${skippedCount} ç­†ä¸­æ–‡IDçš„è¨˜éŒ„`, 'warning');
        }

        // å‰µå»ºä¸‹è¼‰éˆæ¥
        const jsonStr = JSON.stringify(exportData, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `admission_scores_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        log(`âœ… æˆåŠŸå°å‡º ${exportData.universities.length} æ‰€å¤§å­¸çš„éŒ„å–åˆ†æ•¸æ•¸æ“š`, 'success');
        
      } catch (error) {
        log('âŒ å°å‡ºå¤±æ•—ï¼š' + error.message, 'error');
        console.error(error);
      }
    }

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      if (initFirebase()) {
        log('âœ… Firebase å·²åˆå§‹åŒ–', 'success');
      }
      if (initSupabase()) {
        log('âœ… Supabase å·²åˆå§‹åŒ–', 'success');
      }
      log('ğŸ‰ å·¥å…·å·²æº–å‚™å°±ç·’ï¼Œè«‹é»æ“Šã€Œæª¢æŸ¥æ‰€æœ‰å¤§å­¸ã€é–‹å§‹', 'info');
      log('ğŸ’¡ æç¤ºï¼šæœ¬å·¥å…·ä½¿ç”¨ AI æ™ºèƒ½åˆ¤å®šï¼Œæ¯æ‰€å¤§å­¸çš„ç§‘ç³»éƒ½æ˜¯æ ¹æ“šå¯¦éš›æƒ…æ³ç”Ÿæˆçš„', 'info');
      log('ğŸ’¡ æç¤ºï¼šéŒ„å–åˆ†æ•¸æœç´¢åŠŸèƒ½ä½¿ç”¨æ–‡å¿ƒ Web Searchï¼ŒæœƒæŒ‰å¹´ä»½ä¿å­˜åˆ° Firebase', 'info');
    });
  </script>
</body>
</html>

# OCR 考程表識別改進說明

## 📋 改進內容

### 1. ✅ 改進 AI 提示詞
- **問題**：原提示詞過於簡單，無法很好地理解表格格式的考程表
- **解決方案**：
  - 添加了詳細的表格格式說明（周次、日期、上午/下午時間段）
  - 明確了日期處理規則（中文日期轉換為 YYYY-MM-DD）
  - 添加了時間處理規則（上午=09:00，下午=14:00）
  - 添加了科目名稱清理規則
  - 明確了考試類型判斷邏輯（測驗 vs 考試）
  - 添加了忽略項目說明（報告、放假等）

### 2. ✅ 改進 OCR 文本清理
- **問題**：原清理邏輯過於激進，可能丟失表格結構信息
- **解決方案**：
  - 保留表格分隔符和換行結構
  - 改進空白處理（保留必要的換行）
  - 清理行首行尾空白但保留內容結構

### 3. ✅ 增強備用解析邏輯
- **問題**：當 AI 解析失敗時，備用方案無法處理中文日期格式
- **解決方案**：
  - 添加中文日期模式識別（如：11月24日 → 2024-11-24）
  - 改進日期年份推斷邏輯
  - 擴展科目關鍵字列表
  - 改進考試類型判斷
  - 添加報告和放假信息過濾

### 4. ✅ 添加 PDF 支持
- **問題**：原系統只支持圖片文件
- **解決方案**：
  - 添加 PDF.js 庫支持
  - 實現 PDF 轉圖片功能（第一頁，2倍分辨率）
  - 更新文件上傳界面支持 PDF
  - 自動檢測文件類型並處理

## 🚀 使用方法

### 上傳考程表

1. **支持的文件格式**：
   - 圖片：JPG、PNG
   - PDF：PDF 文件（會自動轉換為圖片）

2. **上傳步驟**：
   - 點擊「上傳考程表圖片或PDF」
   - 選擇圖片或 PDF 文件
   - 系統會自動：
     - 如果是 PDF，先轉換為圖片
     - 使用 PaddleOCR-VL 進行 OCR 識別
     - 使用文心一言 AI 整理成結構化數據
     - 保存到數據庫

### 改進的識別能力

系統現在可以更好地識別：

- ✅ **表格格式**：包含周次、日期、時間段的複雜表格
- ✅ **中文日期**：11月24日、12月4日等格式
- ✅ **時間段**：上午/下午自動轉換為具體時間
- ✅ **科目名稱**：自動清理多餘描述詞，保留核心科目
- ✅ **考試類型**：自動區分測驗（test）和考試（exam）
- ✅ **過濾無關信息**：自動忽略報告和放假信息

## 📝 示例

### 輸入（OCR識別結果）
```
第13周 大測周
11月24日 校慶補假
11月26日 數學大測3
11月27日 文法大測1
11月28日 中文大測2
```

### 輸出（結構化數據）
```json
[
  {
    "subject": "數學",
    "exam_date": "2024-11-26",
    "exam_time": "09:00",
    "exam_type": "test"
  },
  {
    "subject": "文法",
    "exam_date": "2024-11-27",
    "exam_time": "09:00",
    "exam_type": "test"
  },
  {
    "subject": "中文",
    "exam_date": "2024-11-28",
    "exam_time": "09:00",
    "exam_type": "test"
  }
]
```

## 🔧 技術細節

### AI 提示詞改進
- 溫度降低到 0.1（提高準確性）
- 最大 token 增加到 4000（處理更多考試項目）
- 添加詳細的解析規則和示例

### OCR 文本處理
- 保留表格結構（換行、分隔符）
- 改進空白處理
- 更好的行級清理

### 備用解析邏輯
- 支持中文日期格式
- 智能年份推斷
- 擴展的科目和考試類型識別

### PDF 處理
- 使用 PDF.js 3.11.174
- 2倍分辨率渲染（提高 OCR 準確性）
- 自動處理第一頁

## ⚠️ 注意事項

1. **PDF 文件**：
   - 只處理第一頁
   - 建議考程表在第一頁
   - 文件大小限制 10MB

2. **圖片質量**：
   - 建議使用清晰、高分辨率的圖片
   - 避免模糊、傾斜的圖片
   - 確保文字清晰可讀

3. **表格格式**：
   - 系統已優化處理表格格式
   - 但複雜的表格可能仍需要人工檢查

4. **日期推斷**：
   - 系統會根據當前日期推斷年份
   - 如果月份小於當前月份，會推斷為明年

## 🐛 故障排除

### 如果識別結果不準確：

1. **檢查圖片質量**：
   - 確保圖片清晰
   - 避免模糊或傾斜

2. **檢查文件格式**：
   - 確認是支持的格式（JPG、PNG、PDF）
   - 確認文件大小不超過 10MB

3. **檢查 OCR 結果**：
   - 查看控制台日誌中的 OCR 識別文字
   - 如果 OCR 結果本身混亂，AI 整理也會受影響

4. **手動調整**：
   - 如果自動識別不準確，可以手動編輯考程表

## 📚 相關文件

- `supabase/functions/process-schedule/index.ts` - OCR 處理 Edge Function
- `app.js` - 前端文件上傳和處理邏輯
- `index.html` - 用戶界面


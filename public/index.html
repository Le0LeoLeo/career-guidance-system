<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>校園升學與職涯助手</title>
  <style>
    :root {
      --primary-color: #007bff;
      --primary-hover: #0056b3;
      --border-color: #dee2e6;
      --card-bg: #ffffff;
      --body-bg: #f8f9fa;
      --text-color: #212529;
      --muted-color: #6c757d;
      --success-color: #28a745;
      --error-color: #dc3545;
    }
    body { 
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif; 
      margin: 0;
      background-color: var(--body-bg);
      color: var(--text-color);
      line-height: 1.6;
    }
    .container { max-width: 800px; margin: 24px auto; padding: 0 24px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    button { 
      padding: 10px 16px; 
      cursor: pointer; 
      border-radius: 8px; 
      border: 1px solid transparent;
      font-size: 1rem;
      transition: background-color 0.2s ease;
    }
    button.primary { 
      background-color: var(--primary-color); 
      color: white; 
      border-color: var(--primary-color);
    }
    button.primary:hover { background-color: var(--primary-hover); }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    .card { 
      border: 1px solid var(--border-color); 
      border-radius: 12px; 
      padding: 24px; 
      margin-top: 24px; 
      background-color: var(--card-bg);
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .muted { color: var(--muted-color); font-size: 0.9rem; }
    .options { display: grid; gap: 10px; margin-top: 12px; }
    .opt { 
      text-align: left; 
      width: 100%; 
      border: 1px solid var(--border-color); 
      border-radius: 10px; 
      padding: 12px; 
      background: var(--card-bg); 
    }
    .opt:hover { background: #f7f7f7; }
    .opt.selected { background-color: #e6f7ff; border-color: var(--primary-color); }
    pre { 
      white-space: pre-wrap; 
      word-break: break-word; 
      background: #0b1020; 
      color: #d7e1ff; 
      padding: 16px; 
      border-radius: 10px; 
      overflow: auto; 
      max-height: 300px;
    }
    input[type="text"], input[type="file"] { 
      padding: 10px; 
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
    }
    input[type="text"] { min-width: 280px; }
    hr { border: 0; border-top: 1px solid var(--border-color); margin: 24px 0; }
    h1, h2 { margin-top: 0; }
    .hidden { display: none; }
    .loader { 
      width: 18px; height: 18px; 
      border: 2px solid #FFF; 
      border-bottom-color: transparent; 
      border-radius: 50%; 
      display: inline-block; 
      box-sizing: border-box; 
      animation: rotation 1s linear infinite; 
      margin-left: 8px;
    }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .main-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 24px; border-bottom: 1px solid var(--border-color); }
    .title-group h1 { margin: 0; font-size: 1.5rem; }
    .title-group p { margin: 0; font-size: 0.9rem; }
    .auth-group { display: flex; align-items: center; gap: 12px; }
    .tab-nav { display: flex; gap: 8px; border-bottom: 1px solid var(--border-color); }
    .tab-link { padding: 10px 16px; cursor: pointer; border: none; background: none; border-bottom: 3px solid transparent; font-size: 1rem; color: var(--muted-color); border-radius: 0; }
    .tab-link.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>
  <div class="container">
    <header class="main-header">
      <div class="title-group">
        <h1>校園升學與職涯助手</h1>
        <p class="muted">結合 AI 問卷、成績 OCR 與大學資料，提供個人化分析</p>
      </div>
      <div class="auth-group">
        <span class="muted" id="authStatus">未登入</span>
        <button id="btnLogin" class="primary">Google 登入</button>
        <button id="btnLogout" class="hidden">登出</button>
      </div>
    </header>

    <div id="mainApp" class="hidden">
      <div class="tab-nav">
        <button class="tab-link active" data-tab="assessmentCard">個人化問卷</button>
        <button class="tab-link" data-tab="ocrCard">成績 / 時間表 OCR</button>
        <button class="tab-link" data-tab="analysisCard">目標大學分析</button>
      </div>

      <div id="assessmentCard" class="card tab-content active">
        <h2>個人化問卷</h2>
        <div class="row muted" style="justify-content: space-between;">
          <div>進度: <span id="stage"></span></div>
          <div>信心度: <span id="conf"></span></div>
        </div>
        <hr>
        <h3 id="qPrompt">正在為您準備題目...</h3>
        <div class="options" id="qOptions"></div>
        <div style="margin-top: 10px;">
          <div class="muted">可選填補充（不影響選項權重，僅作為上下文）：</div>
          <input id="userText" type="text" placeholder="例如：我通常會..." style="width: 100%; box-sizing: border-box;" />
        </div>
        <div style="margin-top: 12px; text-align: right;">
          <button id="btnNext" class="primary">取得下一題</button>
        </div>
        <details style="margin-top: 12px;">
            <summary class="muted">顯示/隱藏 Debug state</summary>
            <pre id="debug"></pre>
        </details>
      </div>

      <div id="ocrCard" class="card tab-content">
        <h2>成績 / 時間表 OCR</h2>
        <p class="muted">上傳圖片，系統將自動辨識並結構化您的成績資料。</p>
        <div class="row">
          <input id="ocrFile" type="file" accept="image/*" />
          <button id="btnOcr" class="primary">上傳並 OCR</button>
        </div>
        <div id="ocrResultArea" class="hidden" style="margin-top:16px;">
          <h4>OCR 純文字：</h4>
          <pre id="ocrText"></pre>
          <h4>結構化結果：</h4>
          <pre id="ocrStructured"></pre>
          <div class="row" style="margin-top:10px;">
            <button id="btnSaveOcr" class="primary">儲存此結果</button>
            <span class="muted" id="saveOcrStatus"></span>
          </div>
        </div>
      </div>

      <div id="analysisCard" class="card tab-content">
        <h2>目標大學分析</h2>
        <p class="muted">搜尋大學，選定後系統將整合您的問卷與成績結果進行綜合分析。</p>
        <div class="row">
          <input id="uniQuery" type="text" placeholder="輸入大學名稱關鍵字" />
          <button id="btnUniSearch" class="primary">搜尋</button>
        </div>
        <div style="margin-top:16px;">
          <div class="muted">搜尋結果：</div>
          <div id="uniResults" class="options"></div>
        </div>
        <hr>
        <div class="row">
          <button id="btnRunAnalysis" class="primary">開始分析</button>
          <span class="muted" id="analysisStatus">請先從上方搜尋並選擇一間大學</span>
        </div>
        <div id="analysisResultArea" class="hidden" style="margin-top:16px;">
          <h4>分析結果：</h4>
          <pre id="analysisOut"></pre>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://spsvuybwaciyfwxmvuxh.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_iNkjfB2_8AMe-gw8QroPhw_2RljOBgO";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Element mapping
    const elAuthStatus = document.getElementById("authStatus");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const mainApp = document.getElementById("mainApp");
    
    const elStage = document.getElementById("stage");
    const elConf = document.getElementById("conf");
    const elPrompt = document.getElementById("qPrompt");
    const elOptions = document.getElementById("qOptions");
    const elDebug = document.getElementById("debug");
    const elUserText = document.getElementById("userText");
    const btnNext = document.getElementById("btnNext");

    const elOcrFile = document.getElementById("ocrFile");
    const btnOcr = document.getElementById("btnOcr");
    const elOcrResultArea = document.getElementById("ocrResultArea");
    const elOcrText = document.getElementById("ocrText");
    const elOcrStructured = document.getElementById("ocrStructured");
    const btnSaveOcr = document.getElementById("btnSaveOcr");
    const elSaveOcrStatus = document.getElementById("saveOcrStatus");

    const elUniQuery = document.getElementById("uniQuery");
    const btnUniSearch = document.getElementById("btnUniSearch");
    const elUniResults = document.getElementById("uniResults");
    const btnRunAnalysis = document.getElementById("btnRunAnalysis");
    const elAnalysisStatus = document.getElementById("analysisStatus");
    const elAnalysisResultArea = document.getElementById("analysisResultArea");
    const elAnalysisOut = document.getElementById("analysisOut");

    let lastQuestion = null;
    let lastOcrResult = null;
    let selectedUniversity = null;

    // --- Helper Functions for UI --- 
    function setLoading(button, isLoading) {
      const originalText = button.dataset.originalText || button.innerText;
      if (isLoading) {
        if (!button.dataset.originalText) button.dataset.originalText = button.innerText;
        button.disabled = true;
        button.innerHTML = originalText + ' <span class="loader"></span>';
      } else {
        button.disabled = false;
        if(button.dataset.originalText) button.innerText = button.dataset.originalText;
        const loader = button.querySelector('.loader');
        if (loader) loader.remove();
      }
    }

    async function callApi(endpoint, payload) {
        const token = await getAccessToken();
        if (!token) throw new Error("Not logged in");
        const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
            body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || "API call failed");
        return data;
    }

    async function getAccessToken() {
      const { data } = await sb.auth.getSession();
      return data?.session?.access_token || null;
    }

    async function verifyGate() {
      const token = await getAccessToken();
      if (!token) return { ok: false, error: "Not logged in" };

      const res = await fetch("/.netlify/functions/auth-verify", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
        body: JSON.stringify({}),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) return { ok: false, error: data?.error || "verify failed", details: data };
      return data;
    }

    function renderState(state) {
      elStage.textContent = state?.current_stage || "-";
      elConf.textContent = (state?.confidence_score ?? 0).toFixed(2);
      elDebug.textContent = JSON.stringify(state, null, 2);
    }

    function renderQuestion(q) {
      lastQuestion = q;
      elPrompt.textContent = q.prompt;
      elOptions.innerHTML = "";
      q.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.className = "opt";
        btn.textContent = `${idx + 1}. ${opt.text}`;
        btn.onclick = () => submitAnswer(idx, opt);
        elOptions.appendChild(btn);
      });
    }

    async function fetchNextQuestion(payload = {}) {
      setLoading(btnNext, true);
      try {
        const data = await callApi("/.netlify/functions/assessment-next", payload);
        elUserText.value = "";

        if (data.done) {
          renderState(data.state);
          elPrompt.textContent = "問卷已收斂完成。";
          elOptions.innerHTML = "";
          btnNext.classList.add('hidden');
          return;
        }
        renderState(data.state);
        renderQuestion(data.question);
      } finally {
        setLoading(btnNext, false);
      }
    }

    async function submitAnswer(selectedIndex, selectedOption) {
        if (!lastQuestion) throw new Error("No question");
        const payload = {
            answer: {
                question_id: lastQuestion.question_id,
                selected_index: selectedIndex,
                selected_option: selectedOption,
                user_text: elUserText.value || ""
            }
        };
        await fetchNextQuestion(payload);
    }

    btnLogin.onclick = async () => {
      await sb.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo: window.location.origin }
      });
    };

    btnLogout.onclick = () => sb.auth.signOut();
    btnNext.onclick = () => fetchNextQuestion({});

    async function uploadToSupabase(file) {
      const { data: sess } = await sb.auth.getSession();
      const userId = sess?.session?.user?.id;
      if (!userId) throw new Error("Not logged in");

      const ext = (file.name.split(".").pop() || "png").toLowerCase();
      const path = `${userId}/${Date.now()}_${Math.random().toString(16).slice(2)}.${ext}`;

      const { error } = await sb.storage.from("uploads").upload(path, file, {
        contentType: file.type || "image/png",
        upsert: false,
      });
      if (error) throw new Error("Upload failed: " + error.message);
      return { bucket: "uploads", file_path: path };
    }

    btnOcr.onclick = async () => {
      setLoading(btnOcr, true);
      try {
        elOcrResultArea.classList.add("hidden");
        const file = elOcrFile.files && elOcrFile.files[0];
        if (!file) throw new Error("請先選擇圖片");

        const uploaded = await uploadToSupabase(file);
        const ocrData = await callApi("/.netlify/functions/ocr-deepseek", { bucket: uploaded.bucket, file_path: uploaded.file_path });
        const ocrText = ocrData.ocr_text || "";
        elOcrText.textContent = ocrText || "(辨識為空)";

        const parsedData = await callApi("/.netlify/functions/ocr-parse", { ocr_text: ocrText });
        lastOcrResult = { uploaded, ocrText, parsed: parsedData };
        elOcrStructured.textContent = JSON.stringify(parsedData.items || [], null, 2);
        
        elOcrResultArea.classList.remove("hidden");
        elSaveOcrStatus.textContent = "";
      } catch (e) {
        alert(String(e.message || e));
      } finally {
        setLoading(btnOcr, false);
      }
    };

    btnSaveOcr.onclick = async () => {
      if (!lastOcrResult) {
        elSaveOcrStatus.textContent = "請先上傳並 OCR 圖片";
        return;
      }
      setLoading(btnSaveOcr, true);
      try {
        elSaveOcrStatus.textContent = "儲存中...";
        const payload = {
            storage_bucket: lastOcrResult.uploaded.bucket,
            storage_path: lastOcrResult.uploaded.file_path,
            ocr_text: lastOcrResult.ocrText,
            extracted_items: lastOcrResult.parsed.items || [],
            source_type: "score_sheet"
        };
        await callApi("/.netlify/functions/grades-save", payload);
        elSaveOcrStatus.textContent = "✓ 已儲存";
        setTimeout(() => { elSaveOcrStatus.textContent = ""; }, 3000);
      } catch (e) {
        elSaveOcrStatus.textContent = "儲存失敗: " + (e.message || e);
      } finally {
        setLoading(btnSaveOcr, false);
      }
    };

    async function searchUniversities() {
      const query = (elUniQuery.value || "").trim();
      if (!query) {
        elUniResults.innerHTML = "<div class='muted'>請輸入搜尋關鍵字</div>";
        return;
      }
      setLoading(btnUniSearch, true);
      try {
        elUniResults.innerHTML = "<div class='muted'>搜尋中...</div>";
        const data = await callApi("/.netlify/functions/firebase-universities-search", { q: query });

        if (!data.rows || data.rows.length === 0) {
          elUniResults.innerHTML = "<div class='muted'>沒有找到符合的大學</div>";
          return;
        }

        elUniResults.innerHTML = "";
        data.rows.forEach((uni) => {
          const btn = document.createElement("button");
          btn.className = "opt";
          btn.textContent = `${uni.name} (${uni.id})`;
          btn.onclick = () => {
            selectedUniversity = uni;
            document.querySelectorAll("#uniResults .opt").forEach(el => el.classList.remove('selected'));
            btn.classList.add('selected');
            elAnalysisStatus.textContent = `已選擇: ${uni.name}`;
          };
          elUniResults.appendChild(btn);
        });
      } catch (e) {
        elUniResults.innerHTML = `<div class='muted'>錯誤: ${e.message || e}</div>`;
      } finally {
        setLoading(btnUniSearch, false);
      }
    }

    elUniQuery.addEventListener("keypress", (e) => {
      if (e.key === "Enter") searchUniversities();
    });
    btnUniSearch.onclick = searchUniversities;

    btnRunAnalysis.onclick = async () => {
      if (!selectedUniversity) {
        elAnalysisStatus.textContent = "請先選擇一間大學";
        return;
      }
      setLoading(btnRunAnalysis, true);
      elAnalysisResultArea.classList.add('hidden');
      try {
        elAnalysisStatus.textContent = "分析中...";
        const data = await callApi("/.netlify/functions/target-analysis", { university: selectedUniversity, notes: "" });
        elAnalysisOut.textContent = JSON.stringify(data.analysis || {}, null, 2);
        elAnalysisResultArea.classList.remove('hidden');
        elAnalysisStatus.textContent = "✓ 分析完成";
      } catch (e) {
        elAnalysisStatus.textContent = `分析失敗: ${e.message || e}`;
      } finally {
        setLoading(btnRunAnalysis, false);
      }
    };

    const tabLinks = document.querySelectorAll('.tab-link');
    const tabContents = document.querySelectorAll('.tab-content');
    tabLinks.forEach(link => {
      link.addEventListener('click', () => {
        const tabId = link.getAttribute('data-tab');
        tabLinks.forEach(item => item.classList.remove('active'));
        link.classList.add('active');
        tabContents.forEach(content => {
          content.id === tabId ? content.classList.add('active') : content.classList.remove('active');
        });
      });
    });

    function handleAuthStateChange(session) {
        if (session?.user?.email) {
            elAuthStatus.textContent = "已登入：" + session.user.email;
            btnLogin.classList.add('hidden');
            btnLogout.classList.remove('hidden');
            mainApp.classList.remove('hidden');
        } else {
            elAuthStatus.textContent = "未登入";
            btnLogin.classList.remove('hidden');
            btnLogout.classList.add('hidden');
            mainApp.classList.add('hidden');
        }
    }

    (async function() {
      sb.auth.onAuthStateChange((event, session) => handleAuthStateChange(session));
      const { data } = await sb.auth.getSession();
      handleAuthStateChange(data.session);
      
      if (data?.session?.user) {
        const gate = await verifyGate();
        if (gate.ok) {
          await fetchNextQuestion({});
        } else {
          alert("此帳號不允許使用：" + (gate.error || "Denied"));
          await sb.auth.signOut();
        }
      }
    })();
  </script>
</body>
</html>
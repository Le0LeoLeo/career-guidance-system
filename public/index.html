<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>校園升學與職涯助手</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif; margin: 24px; line-height: 1.5; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    button { padding: 10px 14px; cursor: pointer; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin-top: 14px; }
    .muted { color: #666; font-size: 13px; }
    .options { display: grid; gap: 10px; margin-top: 12px; }
    .opt { text-align: left; width: 100%; border: 1px solid #ccc; border-radius: 10px; padding: 12px; background: #fff; }
    .opt:hover { background: #f7f7f7; }
    pre { white-space: pre-wrap; word-break: break-word; background: #0b1020; color: #d7e1ff; padding: 12px; border-radius: 10px; overflow:auto; }
    input[type="text"] { padding: 10px; min-width: 280px; }
  </style>
</head>
<body>
  <h1>校園升學與職涯助手</h1>

  <div class="card">
    <div class="row">
      <button id="btnLogin">Google 登入</button>
      <button id="btnLogout">登出</button>
      <span class="muted" id="authStatus">未登入</span>
    </div>
    <div class="muted" style="margin-top:10px;">
      前端只負責登入拿到 access_token，所有權限驗證/AI 出題都在 Netlify Functions。
    </div>
  </div>

  <div class="card" id="quizCard" style="display:none;">
    <hr style="margin:14px 0;" />

    <h2 style="margin:0 0 8px 0;">成績 / 時間表 OCR</h2>
    <div class="muted">上傳圖片到 Supabase Storage（bucket: uploads），再用 DeepSeek-OCR 辨識，最後整理成結構化 JSON。</div>

    <div style="margin-top:10px;" class="row">
      <input id="ocrFile" type="file" accept="image/*" />
      <button id="btnOcr">上傳並 OCR</button>
    </div>

    <div style="margin-top:10px;">
      <div class="muted">OCR 純文字：</div>
      <pre id="ocrText"></pre>
    </div>

    <div style="margin-top:10px;">
      <div class="muted">結構化結果（可讓用戶手動確認/補充分數）：</div>
      <pre id="ocrStructured"></pre>
      <div class="row" style="margin-top:10px;">
        <button id="btnSaveOcr">儲存此結果</button>
        <span class="muted" id="saveOcrStatus"></span>
      </div>
    </div>

    <h2 style="margin:14px 0 8px 0;">目標大學分析</h2>
    <div class="muted">搜尋 Firebase 大學資料（server-side），選定後整合你的成績與問卷結果做分析。</div>

    <div class="row" style="margin-top:10px;">
      <input id="uniQuery" type="text" placeholder="輸入大學名稱關鍵字" />
      <button id="btnUniSearch">搜尋</button>
    </div>

    <div style="margin-top:10px;">
      <div class="muted">搜尋結果：</div>
      <div id="uniResults" class="options"></div>
    </div>

    <div style="margin-top:10px;" class="row">
      <button id="btnRunAnalysis">開始分析</button>
      <span class="muted" id="analysisStatus"></span>
    </div>

    <div style="margin-top:10px;">
      <div class="muted">分析結果（JSON）：</div>
      <pre id="analysisOut"></pre>
    </div>

    <hr style="margin:14px 0;" />

    <div class="row" style="justify-content: space-between;">
      <div>
        <div class="muted">Stage: <span id="stage"></span> ／ Confidence: <span id="conf"></span></div>
      </div>
      <button id="btnNext">取得下一題</button>
    </div>

    <h2 id="qPrompt" style="margin-top:10px;"></h2>
    <div class="options" id="qOptions"></div>

    <div style="margin-top: 10px;">
      <div class="muted">可選填補充（不影響選項權重，僅作為上下文）：</div>
      <input id="userText" type="text" placeholder="例如：我通常會..." />
    </div>

    <div style="margin-top: 12px;">
      <div class="muted">Debug state（前端僅顯示 server 回傳結果）：</div>
      <pre id="debug"></pre>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = "https://spsvuybwaciyfwxmvuxh.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_iNkjfB2_8AMe-gw8QroPhw_2RljOBgO";

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const elAuthStatus = document.getElementById("authStatus");
    const quizCard = document.getElementById("quizCard");
    const elStage = document.getElementById("stage");
    const elConf = document.getElementById("conf");
    const elPrompt = document.getElementById("qPrompt");
    const elOptions = document.getElementById("qOptions");
    const elDebug = document.getElementById("debug");
    const elUserText = document.getElementById("userText");

    const elOcrFile = document.getElementById("ocrFile");
    const elOcrText = document.getElementById("ocrText");
    const elOcrStructured = document.getElementById("ocrStructured");
    const elSaveOcrStatus = document.getElementById("saveOcrStatus");
    const elUniQuery = document.getElementById("uniQuery");
    const elUniResults = document.getElementById("uniResults");
    const elAnalysisStatus = document.getElementById("analysisStatus");
    const elAnalysisOut = document.getElementById("analysisOut");

    let lastQuestion = null;
    let lastOcrResult = null;
    let lastUploadedFile = null;
    let selectedUniversity = null;


    async function getAccessToken() {
      const { data } = await sb.auth.getSession();
      return data?.session?.access_token || null;
    }

    async function verifyGate() {
      const token = await getAccessToken();
      if (!token) return { ok: false, error: "Not logged in" };

      const res = await fetch("/.netlify/functions/auth-verify", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
        body: JSON.stringify({}),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) return { ok: false, error: data?.error || "verify failed", details: data };
      return data;
    }

    function renderState(state) {
      elStage.textContent = state?.current_stage || "-";
      elConf.textContent = (state?.confidence_score ?? 0).toFixed(2);
      elDebug.textContent = JSON.stringify(state, null, 2);
    }

    function renderQuestion(q) {
      lastQuestion = q;
      elPrompt.textContent = q.prompt;
      elOptions.innerHTML = "";
      q.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.className = "opt";
        btn.textContent = `${idx + 1}. ${opt.text}`;
        btn.onclick = () => submitAnswer(idx, opt);
        elOptions.appendChild(btn);
      });
    }

    async function fetchNextQuestion() {
      const token = await getAccessToken();
      if (!token) throw new Error("Not logged in");

      const res = await fetch("/.netlify/functions/assessment-next", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
        body: JSON.stringify({}),
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || "Failed");
      if (data.done) {
        renderState(data.state);
        elPrompt.textContent = "問卷已收斂完成。";
        elOptions.innerHTML = "";
        return;
      }
      renderState(data.state);
      renderQuestion(data.question);
    }

    async function submitAnswer(selectedIndex, selectedOption) {
      const token = await getAccessToken();
      if (!token) throw new Error("Not logged in");
      if (!lastQuestion) throw new Error("No question");

      const payload = {
        answer: {
          question_id: lastQuestion.question_id,
          selected_index: selectedIndex,
          selected_option: selectedOption,
          user_text: elUserText.value || ""
        }
      };

      const res = await fetch("/.netlify/functions/assessment-next", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
        body: JSON.stringify(payload),
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || "Failed");
      elUserText.value = "";

      if (data.done) {
        renderState(data.state);
        elPrompt.textContent = "問卷已收斂完成。";
        elOptions.innerHTML = "";
        return;
      }

      renderState(data.state);
      renderQuestion(data.question);
    }

    document.getElementById("btnLogin").onclick = async () => {
      await sb.auth.signInWithOAuth({
        provider: "google",
        options: {
          redirectTo: window.location.origin
        }
      });
    };

    document.getElementById("btnLogout").onclick = async () => {
      await sb.auth.signOut();
      elAuthStatus.textContent = "未登入";
      quizCard.style.display = "none";
    };

    document.getElementById("btnNext").onclick = async () => {
      try {
        await fetchNextQuestion();
      } catch (e) {
        alert(String(e.message || e));
      }
    };

    async function uploadToSupabase(file) {
      const { data: sess } = await sb.auth.getSession();
      const userId = sess?.session?.user?.id;
      if (!userId) throw new Error("Not logged in");

      const ext = (file.name.split(".").pop() || "png").toLowerCase();
      const path = `${userId}/${Date.now()}_${Math.random().toString(16).slice(2)}.${ext}`;

      const { error } = await sb.storage.from("uploads").upload(path, file, {
        contentType: file.type || "image/png",
        upsert: false,
      });
      if (error) throw new Error("Upload failed: " + error.message);
      return { bucket: "uploads", file_path: path };
    }

    async function callDeepseekOcr(bucket, filePath) {
      const token = await getAccessToken();
      if (!token) throw new Error("Not logged in");

      const res = await fetch("/.netlify/functions/ocr-deepseek", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
        body: JSON.stringify({ bucket, file_path: filePath }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || "OCR failed");
      return data.ocr_text || "";
    }

    async function callOcrParse(ocrText) {
      const token = await getAccessToken();
      if (!token) throw new Error("Not logged in");

      const res = await fetch("/.netlify/functions/ocr-parse", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
        body: JSON.stringify({ ocr_text: ocrText }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error || "Parse failed");
      return data;
    }

    document.getElementById("btnOcr").onclick = async () => {
      try {
        elOcrText.textContent = "";
        elOcrStructured.textContent = "";

        const file = elOcrFile.files && elOcrFile.files[0];
        if (!file) throw new Error("請先選擇圖片");

        const gate = await verifyGate();
        if (!gate.ok) throw new Error("未通過權限驗證");

        elOcrText.textContent = "上傳中...";
        const uploaded = await uploadToSupabase(file);
        lastUploadedFile = uploaded;

        elOcrText.textContent = "OCR 辨識中...";
        const ocrText = await callDeepseekOcr(uploaded.bucket, uploaded.file_path);
        elOcrText.textContent = ocrText || "(空)";

        elOcrStructured.textContent = "整理中...";
        const parsed = await callOcrParse(ocrText);
        lastOcrResult = { uploaded, ocrText, parsed };
        elOcrStructured.textContent = JSON.stringify(parsed.items || [], null, 2);
        elSaveOcrStatus.textContent = "";
      } catch (e) {
        alert(String(e.message || e));
      }
    };

    async function saveOcrResult() {
      if (!lastOcrResult) {
        elSaveOcrStatus.textContent = "請先上傳並 OCR 圖片";
        return false;
      }
      try {
        elSaveOcrStatus.textContent = "儲存中...";
        const token = await getAccessToken();
        if (!token) throw new Error("Not logged in");

        const res = await fetch("/.netlify/functions/grades-save", {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
          body: JSON.stringify({
            storage_bucket: lastOcrResult.uploaded.bucket,
            storage_path: lastOcrResult.uploaded.file_path,
            ocr_text: lastOcrResult.ocrText,
            extracted_items: lastOcrResult.parsed.items || [],
            source_type: "score_sheet"
          }),
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || "Save failed");
        
        elSaveOcrStatus.textContent = "✓ 已儲存";
        setTimeout(() => { elSaveOcrStatus.textContent = ""; }, 3000);
        return true;
      } catch (e) {
        elSaveOcrStatus.textContent = "儲存失敗: " + (e.message || e);
        return false;
      }
    }

    async function searchUniversities() {
      const query = (elUniQuery.value || "").trim();
      if (!query) {
        elUniResults.innerHTML = "<div class='muted'>請輸入搜尋關鍵字</div>";
        return;
      }

      try {
        elUniResults.innerHTML = "<div class='muted'>搜尋中...</div>";
        const token = await getAccessToken();
        if (!token) throw new Error("Not logged in");

        const res = await fetch("/.netlify/functions/firebase-universities-search", {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
          body: JSON.stringify({ q: query }),
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || "Search failed");

        if (!data.rows || data.rows.length === 0) {
          elUniResults.innerHTML = "<div class='muted'>沒有找到符合的大學</div>";
          return;
        }

        elUniResults.innerHTML = "";
        data.rows.forEach((uni, idx) => {
          const btn = document.createElement("button");
          btn.className = "opt";
          btn.textContent = `${uni.name} (${uni.id})`;
          btn.onclick = () => {
            selectedUniversity = uni;
            document.querySelectorAll("#uniResults .opt").forEach(el => {
              el.style.background = "#fff";
            });
            btn.style.background = "#e6f7ff";
            elAnalysisStatus.textContent = `已選擇: ${uni.name}`;
          };
          elUniResults.appendChild(btn);
        });
      } catch (e) {
        elUniResults.innerHTML = `<div class='muted'>錯誤: ${e.message || e}</div>`;
      }
    }

    async function runTargetAnalysis() {
      if (!selectedUniversity) {
        elAnalysisStatus.textContent = "請先選擇一間大學";
        return;
      }

      try {
        elAnalysisStatus.textContent = "分析中...";
        elAnalysisOut.textContent = "";
        
        const token = await getAccessToken();
        if (!token) throw new Error("Not logged in");

        const res = await fetch("/.netlify/functions/target-analysis", {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
          body: JSON.stringify({
            university: selectedUniversity,
            notes: ""
          }),
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || "Analysis failed");
        
        elAnalysisOut.textContent = JSON.stringify(data.analysis || {}, null, 2);
        elAnalysisStatus.textContent = "✓ 分析完成";
      } catch (e) {
        elAnalysisStatus.textContent = `分析失敗: ${e.message || e}`;
        elAnalysisOut.textContent = "";
      }
    }

    // 綁定新按鈕事件
    document.getElementById("btnSaveOcr").onclick = saveOcrResult;
    document.getElementById("btnUniSearch").onclick = searchUniversities;
    elUniQuery.addEventListener("keypress", (e) => {
      if (e.key === "Enter") searchUniversities();
    });
    document.getElementById("btnRunAnalysis").onclick = runTargetAnalysis;

    (async function() {
      const { data } = await sb.auth.getSession();
      if (data?.session?.user?.email) {
        elAuthStatus.textContent = "已登入：" + data.session.user.email;
        const gate = await verifyGate();
        if (gate.ok) {
          quizCard.style.display = "block";
          await fetchNextQuestion();
        } else {
          quizCard.style.display = "none";
          alert("此帳號不允許使用：" + (gate.error || "Denied"));
          await sb.auth.signOut();
        }
      }

      sb.auth.onAuthStateChange(async (event, session) => {
        if (session?.user?.email) {
          elAuthStatus.textContent = "已登入：" + session.user.email;
          const gate = await verifyGate();
          if (gate.ok) {
            quizCard.style.display = "block";
            await fetchNextQuestion();
          } else {
            quizCard.style.display = "none";
            alert("此帳號不允許使用：" + (gate.error || "Denied"));
            await sb.auth.signOut();
          }
        } else {
          elAuthStatus.textContent = "未登入";
          quizCard.style.display = "none";
        }
      });
    })();
  </script>
</body>
</html>


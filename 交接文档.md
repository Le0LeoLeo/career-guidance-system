# 职业指导系统 (Career Guidance System) 交接文档

## 📋 项目概述

**项目名称**: career-guidance-system  
**项目类型**: 职业指导与学业评估系统  
**主要技术栈**: 
- 前端: HTML/JavaScript (静态页面)
- 后端: Cloudflare Pages Functions / Netlify Functions
- 数据库: Supabase (PostgreSQL)
- 认证: Supabase Auth (Google OAuth)
- 部署平台: Cloudflare Pages

**GitHub 仓库**: `Le0LeoLeo/career-guidance-system`  
**生产分支**: `develop`

---

## 🏗️ 项目结构

```
career-guidance-system/
├── public/                    # 静态文件目录（前端页面）
│   └── index.html
├── netlify/                   # Netlify Functions（兼容 Cloudflare）
│   └── functions/
│       ├── auth-verify.js           # 用户认证验证
│       ├── assessment-next.js       # 职业评估计算
│       ├── firebase-universities-search.js  # 大学搜索
│       ├── grades-list.js           # 成绩列表查询
│       ├── grades-save.js           # 成绩保存
│       ├── ocr-deepseek.js          # OCR 识别（DeepSeek API）
│       ├── ocr-parse.js             # OCR 结果解析
│       └── target-analysis.js       # 目标分析
├── functions/                 # 备用函数目录
├── wrangler.toml             # Cloudflare Pages 配置文件（重要！）
├── netlify.toml              # Netlify 配置文件
├── package.json              # 项目依赖
└── user_grades_table.sql     # 数据库表结构定义
```

---

## 🔧 核心功能模块

### 1. 用户认证 (`auth-verify.js`)
- **功能**: 验证用户身份和权限
- **限制条件**:
  - 仅允许 `@fct.edu.mo` 域名的邮箱
  - 仅允许 Google OAuth 登录
  - 封禁特定邮箱: `iopiopiopiopiopiop9990@gmail.com`
- **返回**: 用户 ID 和邮箱信息

### 2. 职业评估 (`assessment-next.js`)
- **功能**: 计算 MBTI 和霍兰德职业兴趣测试结果
- **算法**: 
  - MBTI 收敛判断（4 个维度）
  - 霍兰德收敛判断（6 种类型）
- **输出**: 评估结果和建议

### 3. OCR 功能
- **`ocr-deepseek.js`**: 使用 DeepSeek API 进行图片文字识别
- **`ocr-parse.js`**: 解析 OCR 结果，提取结构化数据

### 4. 成绩管理
- **`grades-list.js`**: 查询用户的成绩记录
- **`grades-save.js`**: 保存用户确认/编辑后的成绩数据
- **数据存储**: Supabase `user_grades` 表

### 5. 大学搜索 (`firebase-universities-search.js`)
- **功能**: 搜索大学信息（使用 Firebase）

### 6. 目标分析 (`target-analysis.js`)
- **功能**: 分析用户设定的目标

---

## ⚙️ 部署配置

### Cloudflare Pages 配置

#### 1. 基本设置
- **生产分支**: `develop`
- **构建命令**: `npm install`
- **构建输出目录**: `public`
- **Functions 目录**: `/functions` (Cloudflare 会自动检测)

#### 2. 关键配置文件: `wrangler.toml`

```toml
# wrangler.toml
name = "career-guidance-system"
compatibility_date = "2024-05-01"

[[pages.functions.compatibility_flags]]
# Enable Node.js compatibility
nodejs_compat = true
```

**⚠️ 重要**: 此文件是解决 Node.js 内置模块兼容性问题的关键！必须存在于项目根目录。

#### 3. 环境变量

需要在 Cloudflare Pages 中配置以下环境变量：

| 变量名 | 说明 | 是否必需 |
|--------|------|----------|
| `SUPABASE_URL` | Supabase 项目 URL | ✅ 必需 |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabase 服务角色密钥 | ✅ 必需 |
| `QIANFAN_API_KEY` | 百度千帆 API 密钥 | ⚠️ 部分功能需要 |
| `DEEPSEEK_API_KEY` | DeepSeek API 密钥 | ⚠️ OCR 功能需要 |

**配置位置**: Cloudflare Pages > Settings > Environment variables

#### 4. 兼容性设置

在 Cloudflare Pages 设置中：
- **Compatibility Flags**: 添加 `nodejs_compat`
- **Compatibility Date**: `2024-05-01` 或更新

---

## 🐛 已知问题与解决方案

### 问题 1: Node.js 内置模块无法解析

**错误信息**:
```
Could not resolve "crypto"
Could not resolve "fs"
Could not resolve "util"
...
```

**原因**: Cloudflare Pages 默认不支持 Node.js 内置模块，需要启用 `nodejs_compat` 兼容性标志。

**解决方案**:
1. ✅ 在项目根目录创建 `wrangler.toml` 文件（已创建）
2. ✅ 在 Cloudflare Pages 设置中启用 `nodejs_compat` 标志
3. ✅ 设置 `compatibility_date` 为 `2024-05-01` 或更新

**验证方法**: 部署日志中应显示 `wrangler.toml` 文件被找到，而不是 `No wrangler.toml file found. Continuing.`

### 问题 2: Cloudflare 部署旧版本代码

**症状**: 部署日志显示 `HEAD is now at 8329188`，但实际最新提交是更新的版本。

**原因**: Cloudflare 缓存或 Git 同步问题。

**解决方案**:
1. 在 Cloudflare Pages 设置中，重新选择 GitHub 仓库并保存
2. 点击 "Clear cache and deploy site"
3. 如果仍无效，删除并重新创建 Pages 项目

---

## 📦 依赖管理

### package.json

```json
{
  "name": "campus-assistant",
  "private": true,
  "version": "1.0.0",
  "type": "commonjs",
  "dependencies": {
    "firebase-admin": "^12.5.0"
  }
}
```

**注意**: 
- 项目使用 `commonjs` 模块系统
- 主要依赖 `firebase-admin`（用于 Firebase 相关功能）

---

## 🗄️ 数据库结构

### user_grades 表

用于存储用户的 OCR 上传和成绩数据。

**主要字段**:
- `id`: UUID 主键
- `user_id`: 用户 ID（关联 `auth.users`）
- `storage_bucket`: 存储桶名称（默认 'uploads'）
- `storage_path`: 文件存储路径
- `ocr_text`: OCR 识别的原始文本
- `extracted_items`: 提取的结构化数据（JSONB）
- `confirmed_items`: 用户确认/编辑后的数据（JSONB）
- `source_type`: 来源类型（如 'score_sheet', 'exam_schedule'）
- `created_at`, `updated_at`: 时间戳

**安全策略**: 启用 Row Level Security (RLS)，用户只能访问自己的数据。

**SQL 文件**: `user_grades_table.sql`（包含完整的表结构、索引、触发器和 RLS 策略）

---

## 🚀 部署流程

### 首次部署

1. **准备 GitHub 仓库**
   - 确保代码已推送到 `develop` 分支
   - 确认 `wrangler.toml` 文件存在于根目录

2. **创建 Cloudflare Pages 项目**
   - 登录 Cloudflare Dashboard
   - Workers & Pages > Create application > Pages > Connect to Git
   - 选择 `Le0LeoLeo/career-guidance-system` 仓库
   - 选择 `develop` 分支

3. **配置构建设置**
   - Build command: `npm install`
   - Build output directory: `public`

4. **配置环境变量**
   - 添加所有必需的环境变量（见上方表格）
   - 确保敏感信息已加密

5. **配置兼容性**
   - Compatibility Flags: 添加 `nodejs_compat`
   - Compatibility Date: `2024-05-01`

6. **保存并部署**

### 更新部署

1. 推送代码到 `develop` 分支
2. Cloudflare 会自动触发部署
3. 如果遇到问题，可在部署页面点击 "Clear cache and deploy site"

---

## 🔍 故障排查

### 部署失败检查清单

- [ ] 确认 `wrangler.toml` 文件存在于根目录
- [ ] 确认 Cloudflare 部署的是最新提交（检查部署日志中的 `HEAD is now at`）
- [ ] 确认 `nodejs_compat` 标志已启用
- [ ] 确认所有必需的环境变量已配置
- [ ] 检查部署日志中的具体错误信息

### 常见错误

1. **`No wrangler.toml file found`**
   - 解决: 确认文件已提交并推送到 GitHub

2. **`Could not resolve "crypto"` 等 Node.js 模块错误**
   - 解决: 确认 `wrangler.toml` 中 `nodejs_compat = true` 已设置

3. **环境变量未找到**
   - 解决: 在 Cloudflare Pages 设置中检查环境变量配置

---

## 📝 代码规范

### 函数结构

所有 Functions 遵循以下结构：

```javascript
// 标准响应格式
function json(statusCode, body) {
  return {
    statusCode,
    headers: {
      "Content-Type": "application/json; charset=utf-8",
      "Cache-Control": "no-store",
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Headers": "authorization, content-type",
      "Access-Control-Allow-Methods": "POST, OPTIONS",
    },
    body: JSON.stringify(body),
  };
}

// 处理 OPTIONS 预检请求
if (event.httpMethod === "OPTIONS") return json(204, {});

// 主逻辑
exports.handler = async (event) => {
  // ...
};
```

### 安全限制

- 所有函数都通过 `auth-verify.js` 进行身份验证
- 仅允许 `@fct.edu.mo` 域名的用户
- 使用 Supabase RLS 保护数据库数据

---

## 🔐 安全注意事项

1. **环境变量**: 所有敏感信息（API 密钥、服务密钥）必须通过 Cloudflare Pages 环境变量配置，**不要**提交到代码仓库

2. **认证**: 所有需要认证的接口都应先调用 `auth-verify` 验证用户身份

3. **域名限制**: 系统仅允许特定域名的用户访问（`@fct.edu.mo`）

4. **CORS**: 已配置 CORS 允许跨域请求，生产环境可能需要限制来源

---

## 📞 联系方式与资源

- **GitHub 仓库**: https://github.com/Le0LeoLeo/career-guidance-system
- **Cloudflare 文档**: https://developers.cloudflare.com/pages/
- **Supabase 文档**: https://supabase.com/docs
- **Wrangler 配置**: https://developers.cloudflare.com/workers/wrangler/configuration/

---

## 📅 更新记录

- **2024-01-01**: 创建 `wrangler.toml` 配置文件，解决 Node.js 模块兼容性问题
- **2024-01-01**: 修复 `firebase-admin` 导入问题（移至顶层）

---

## ⚠️ 重要提醒

1. **`wrangler.toml` 文件至关重要**: 此文件是 Cloudflare Pages 识别 Node.js 兼容性设置的关键，**不要删除或修改**（除非明确知道后果）

2. **分支管理**: 生产环境使用 `develop` 分支，确保所有更改都经过测试后再合并

3. **环境变量**: 更新环境变量后需要重新部署才能生效

4. **部署验证**: 每次部署后，检查部署日志确认 `wrangler.toml` 被正确识别

---

**文档版本**: 1.0  
**最后更新**: 2024-01-01  
**维护者**: [待填写]


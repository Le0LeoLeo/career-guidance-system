<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™¾åº¦æ–‡å¿ƒ 4.5T API æµ‹è¯•é¡µé¢</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .code-block {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 1rem;
      border-radius: 0.5rem;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .response-box {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      padding: 1rem;
      max-height: 400px;
      overflow-y: auto;
    }
    .test-section {
      border: 2px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-success { background: #d1fae5; color: #065f46; }
    .status-error { background: #fee2e2; color: #991b1b; }
    .status-pending { background: #fef3c7; color: #92400e; }
  </style>
</head>
<body class="bg-gray-50">
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- æ ‡é¢˜ -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">ç™¾åº¦æ–‡å¿ƒ 4.5T API æµ‹è¯•é¡µé¢</h1>
      <p class="text-gray-600">æµ‹è¯•å’Œæ¼”ç¤ºç™¾åº¦åƒå¸†å¹³å° ERNIE-4.5-Turbo-128K API çš„ä½¿ç”¨</p>
    </div>

    <!-- API ä¿¡æ¯å¡ç‰‡ -->
    <div class="test-section bg-white">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“‹ API ä¿¡æ¯</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <h3 class="font-semibold text-gray-700 mb-2">æ¨¡å‹åç§°</h3>
          <p class="text-gray-900 font-mono bg-gray-100 p-2 rounded">ernie-4.5-turbo-128k</p>
        </div>
        <div>
          <h3 class="font-semibold text-gray-700 mb-2">API ç«¯ç‚¹</h3>
          <p class="text-gray-900 font-mono bg-gray-100 p-2 rounded text-sm break-all">https://qianfan.baidubce.com/v2/chat/completions</p>
        </div>
        <div>
          <h3 class="font-semibold text-gray-700 mb-2">è®¤è¯æ–¹å¼</h3>
          <p class="text-gray-900">Bearer Token (API Key æˆ– Access Token)</p>
        </div>
        <div>
          <h3 class="font-semibold text-gray-700 mb-2">é¡¹ç›®é›†æˆ</h3>
          <p class="text-gray-900">é€šè¿‡ Supabase Edge Function è°ƒç”¨</p>
        </div>
      </div>
    </div>

    <!-- æµ‹è¯•é…ç½® -->
    <div class="test-section bg-white">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">âš™ï¸ æµ‹è¯•é…ç½®</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Supabase URL</label>
          <input 
            type="text" 
            id="supabase-url" 
            value="https://naqyczuuariosniudbsr.supabase.co"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
            placeholder="https://your-project.supabase.co"
          >
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Supabase Anon Key</label>
          <input 
            type="password" 
            id="supabase-key" 
            value=""
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
            placeholder="è¾“å…¥æ‚¨çš„ Supabase Anon Key"
          >
          <p class="text-xs text-gray-500 mt-1">ç”¨äºè°ƒç”¨ Edge Functionï¼Œä¸ä¼šå‘é€åˆ°ç™¾åº¦ API</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ç³»ç»Ÿæç¤ºè¯ï¼ˆå¯é€‰ï¼‰</label>
          <textarea 
            id="system-prompt" 
            rows="3"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„èŒæ¶¯è¾…å¯¼é¡¾é—®..."
          >ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„èŒæ¶¯è¾…å¯¼é¡¾é—®ï¼Œæ“…é•¿å¸®åŠ©å­¦ç”Ÿæ¢ç´¢èŒæ¶¯æ–¹å‘ã€åˆ¶å®šå­¦ä¹ è®¡åˆ’ã€å‡†å¤‡å‡å­¦ç”³è¯·ç­‰ã€‚è¯·ç”¨å‹å–„ã€ä¸“ä¸šçš„è¯­æ°”å›ç­”å­¦ç”Ÿçš„é—®é¢˜ã€‚</textarea>
        </div>
        
        <!-- API Key è®¾ç½®è¯´æ˜ -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-yellow-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div class="ml-3 flex-1">
              <h3 class="text-sm font-semibold text-yellow-800 mb-2">ğŸ”‘ ç™¾åº¦ API Key è®¾ç½®</h3>
              <p class="text-sm text-yellow-700 mb-3">
                API Key éœ€è¦å­˜å‚¨åœ¨ Supabase Secrets ä¸­ï¼Œè€Œä¸æ˜¯åœ¨é¡µé¢ä¸Šè¾“å…¥ã€‚è¿™æ˜¯ä¸ºäº†å®‰å…¨è€ƒè™‘ï¼ŒAPI Key ä¸ä¼šæš´éœ²åœ¨å‰ç«¯ä»£ç ä¸­ã€‚
              </p>
              <div class="space-y-2">
                <p class="text-sm font-semibold text-yellow-800">è®¾ç½®æ–¹æ³•ï¼š</p>
                <ol class="list-decimal list-inside space-y-1 text-sm text-yellow-700 ml-2">
                  <li>æ‰“å¼€ PowerShell ç»ˆç«¯</li>
                  <li>è¿è¡Œå¸®åŠ©è„šæœ¬ï¼š<code class="bg-yellow-100 px-1.5 py-0.5 rounded text-xs font-mono">.\set-baidu-api-key.ps1</code></li>
                  <li>æˆ–è€…æ‰‹åŠ¨è¿è¡Œï¼š<code class="bg-yellow-100 px-1.5 py-0.5 rounded text-xs font-mono">npx supabase secrets set BAIDU_API_KEY=bce-v3/your_key</code></li>
                </ol>
                <div class="mt-3 pt-3 border-t border-yellow-300">
                  <p class="text-xs text-yellow-600 mb-2">
                    <strong>æ³¨æ„ï¼š</strong>API Key æ ¼å¼åº”è¯¥æ˜¯ <code class="bg-yellow-100 px-1 py-0.5 rounded text-xs font-mono">bce-v3/xxx</code>ï¼ˆåƒå¸†å¹³å°æ ¼å¼ï¼‰
                  </p>
                  <p class="text-xs text-yellow-600">
                    è®¾ç½®åç­‰å¾… 1-2 åˆ†é’Ÿè®©æ›´æ”¹ç”Ÿæ•ˆï¼Œç„¶åé‡æ–°æµ‹è¯• Edge Functionã€‚
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- äº¤äº’å¼æµ‹è¯• -->
    <div class="test-section bg-white">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ§ª äº¤äº’å¼æµ‹è¯•</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·æ¶ˆæ¯</label>
          <textarea 
            id="user-message" 
            rows="4"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="è¾“å…¥æ‚¨æƒ³è¦æµ‹è¯•çš„é—®é¢˜..."
          >æˆ‘æƒ³äº†è§£å¦‚ä½•å‡†å¤‡ç”³è¯·ç¾å›½çš„ç ”ç©¶æ‰€ï¼Œéœ€è¦å“ªäº›æ­¥éª¤ï¼Ÿ</textarea>
        </div>
        <div class="flex gap-4">
          <button 
            id="test-edge-function-btn"
            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200"
          >
            ğŸš€ æµ‹è¯• Edge Function è°ƒç”¨
          </button>
          <button 
            id="generate-request-btn"
            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200"
          >
            ğŸ“ ç”Ÿæˆ API è¯·æ±‚æ ¼å¼
          </button>
          <button 
            id="diagnose-btn"
            class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200"
          >
            ğŸ” è¯Šæ–­è¿æ¥
          </button>
        </div>
        <div id="test-status" class="hidden">
          <span id="status-badge" class="status-badge"></span>
          <span id="status-message" class="ml-2 text-sm"></span>
        </div>
      </div>
    </div>

    <!-- æµ‹è¯•ç»“æœ -->
    <div class="test-section bg-white" id="test-results-section" style="display: none;">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“Š æµ‹è¯•ç»“æœ</h2>
      <div id="test-results" class="response-box"></div>
    </div>

    <!-- API è¯·æ±‚æ ¼å¼ -->
    <div class="test-section bg-white" id="request-format-section" style="display: none;">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“¤ API è¯·æ±‚æ ¼å¼</h2>
      <div class="space-y-4">
        <div>
          <h3 class="font-semibold text-gray-700 mb-2">HTTP è¯·æ±‚</h3>
          <div id="http-request" class="code-block"></div>
        </div>
        <div>
          <h3 class="font-semibold text-gray-700 mb-2">è¯·æ±‚ä½“ (JSON)</h3>
          <div id="request-body" class="code-block"></div>
        </div>
      </div>
    </div>

    <!-- ä»£ç ç¤ºä¾‹ -->
    <div class="test-section bg-white">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ’» ä»£ç ç¤ºä¾‹</h2>
      <div class="space-y-4">
        <div>
          <h3 class="font-semibold text-gray-700 mb-2">JavaScript (é€šè¿‡ Edge Function)</h3>
          <div class="code-block" id="js-example">// é€šè¿‡ Supabase Edge Function è°ƒç”¨
const { data, error } = await supabase.functions.invoke('ask-ai', {
  body: {
    prompt: 'æ‚¨çš„é—®é¢˜',
    history: [] // å¯é€‰ï¼šå¯¹è¯å†å²
  }
});

if (error) {
  console.error('é”™è¯¯ï¼š', error);
} else {
  console.log('AI å›åº”ï¼š', data.response);
}</div>
        </div>
        <div>
          <h3 class="font-semibold text-gray-700 mb-2">Edge Function (Deno/TypeScript)</h3>
          <div class="code-block" id="edge-function-example">// supabase/functions/ask-ai/index.ts
const apiUrl = 'https://qianfan.baidubce.com/v2/chat/completions';

const response = await fetch(apiUrl, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${authToken}` // API Key æˆ– Access Token
  },
  body: JSON.stringify({
    model: 'ernie-4.5-turbo-128k',
    messages: [
      { role: 'user', content: 'æ‚¨çš„é—®é¢˜' }
    ],
    temperature: 0.7,
    max_tokens: 2000
  })
});

const data = await response.json();
const aiResponse = data.choices[0].message.content;</div>
        </div>
        <div>
          <h3 class="font-semibold text-gray-700 mb-2">cURL å‘½ä»¤</h3>
          <div class="code-block" id="curl-example">curl -X POST https://qianfan.baidubce.com/v2/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -d '{
    "model": "ernie-4.5-turbo-128k",
    "messages": [
      {"role": "user", "content": "æ‚¨çš„é—®é¢˜"}
    ],
    "temperature": 0.7,
    "max_tokens": 2000
  }'</div>
        </div>
      </div>
    </div>

    <!-- é¡¹ç›®é›†æˆè¯´æ˜ -->
    <div class="test-section bg-blue-50 border-blue-200">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ”— é¡¹ç›®é›†æˆè¯´æ˜</h2>
      <div class="space-y-3 text-gray-700">
        <p><strong>å½“å‰é¡¹ç›®æ¶æ„ï¼š</strong></p>
        <ul class="list-disc list-inside space-y-2 ml-4">
          <li>å‰ç«¯ (HTML/JS) â†’ è°ƒç”¨ Supabase Edge Function</li>
          <li>Edge Function â†’ è°ƒç”¨ç™¾åº¦åƒå¸†å¹³å° API</li>
          <li>API Key å­˜å‚¨åœ¨ Supabase Secrets ä¸­</li>
        </ul>
        <p class="mt-4"><strong>ä¼˜åŠ¿ï¼š</strong></p>
        <ul class="list-disc list-inside space-y-2 ml-4">
          <li>API Key ä¸ä¼šæš´éœ²åœ¨å‰ç«¯ä»£ç ä¸­</li>
          <li>ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•</li>
          <li>æ”¯æŒ CORS å’Œè®¤è¯</li>
          <li>å¯ä»¥æ·»åŠ é€Ÿç‡é™åˆ¶å’Œç¼“å­˜</li>
        </ul>
        <p class="mt-4"><strong>ç›¸å…³æ–‡ä»¶ï¼š</strong></p>
        <ul class="list-disc list-inside space-y-2 ml-4 font-mono text-sm">
          <li>supabase/functions/ask-ai/index.ts - Edge Function å®ç°</li>
          <li>app.js - å‰ç«¯è°ƒç”¨ä»£ç </li>
          <li>QUICK_FIX_EDGE_FUNCTION.md - æ•…éšœæ’é™¤æŒ‡å—</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    let supabaseClient = null;

    // å®‰å…¨åœ°è·å–å…ƒç´ å€¼
    function getElementValue(id) {
      const element = document.getElementById(id);
      if (!element) {
        console.error(`å…ƒç´  ${id} ä¸å­˜åœ¨`);
        return '';
      }
      return element.value || '';
    }

    // å®‰å…¨åœ°è®¾ç½®å…ƒç´ å€¼
    function setElementValue(id, value) {
      const element = document.getElementById(id);
      if (!element) {
        console.error(`å…ƒç´  ${id} ä¸å­˜åœ¨`);
        return false;
      }
      element.value = value;
      return true;
    }

    // å®‰å…¨åœ°æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    function safeAddEventListener(id, event, handler) {
      const element = document.getElementById(id);
      if (!element) {
        console.error(`å…ƒç´  ${id} ä¸å­˜åœ¨ï¼Œæ— æ³•æ·»åŠ äº‹ä»¶ç›‘å¬å™¨`);
        return false;
      }
      element.addEventListener(event, handler);
      return true;
    }

    // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
    function initSupabase() {
      const url = getElementValue('supabase-url');
      const key = getElementValue('supabase-key');
      
      if (!url || !key) {
        alert('è¯·å¡«å†™ Supabase URL å’Œ Anon Key');
        return false;
      }

      try {
        supabaseClient = window.supabase.createClient(url, key);
        return true;
      } catch (error) {
        alert('åˆå§‹åŒ– Supabase å¤±è´¥ï¼š' + error.message);
        return false;
      }
    }

    // æµ‹è¯• Edge Function è°ƒç”¨
    safeAddEventListener('test-edge-function-btn', 'click', async () => {
      if (!initSupabase()) return;

      const userMessage = getElementValue('user-message');
      if (!userMessage.trim()) {
        alert('è¯·è¾“å…¥ç”¨æˆ·æ¶ˆæ¯');
        return;
      }

      const statusDiv = document.getElementById('test-status');
      const statusBadge = document.getElementById('status-badge');
      const statusMessage = document.getElementById('status-message');
      const resultsSection = document.getElementById('test-results-section');
      const resultsDiv = document.getElementById('test-results');

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      statusDiv.classList.remove('hidden');
      statusBadge.className = 'status-badge status-pending';
      statusBadge.textContent = 'æµ‹è¯•ä¸­...';
      statusMessage.textContent = 'æ­£åœ¨è°ƒç”¨ Edge Function...';
      resultsSection.style.display = 'none';

      try {
        const startTime = Date.now();
        
        // æ£€æŸ¥ Supabase å®¢æˆ·ç«¯æ˜¯å¦å·²åˆå§‹åŒ–
        if (!supabaseClient) {
          throw new Error('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œè¯·æ£€æŸ¥ URL å’Œ Anon Key');
        }

        // æ£€æŸ¥ Edge Function æ˜¯å¦å­˜åœ¨
        const supabaseUrl = getElementValue('supabase-url');
        const anonKey = getElementValue('supabase-key');
        const functionUrl = `${supabaseUrl}/functions/v1/ask-ai`;
        
        console.log('æ­£åœ¨è°ƒç”¨ Edge Function:', functionUrl);
        console.log('è¯·æ±‚ä½“:', { prompt: userMessage, history: [] });
        
        let data, error;
        
        try {
          const result = await supabaseClient.functions.invoke('ask-ai', {
            body: {
              prompt: userMessage,
              history: []
            }
          });
          data = result.data;
          error = result.error;
        } catch (invokeError) {
          console.error('è°ƒç”¨ Edge Function æ—¶å‘ç”Ÿå¼‚å¸¸:', invokeError);
          error = invokeError;
        }

        const endTime = Date.now();
        const duration = endTime - startTime;

        // å¦‚æœæ˜¯ FunctionsHttpError ä½† context ä¸ºç©ºï¼Œå°è¯•ç›´æ¥è·å–å“åº”
        if (error && error.name === 'FunctionsHttpError' && (!error.context || Object.keys(error.context).length === 0)) {
          console.warn('FunctionsHttpError with empty context, attempting to fetch error details directly...');
          
          // å°è¯•ç›´æ¥è°ƒç”¨ Edge Function è·å–é”™è¯¯è¯¦æƒ…
          try {
            const directResponse = await fetch(functionUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${anonKey}`,
                'apikey': anonKey
              },
              body: JSON.stringify({
                prompt: userMessage,
                history: []
              })
            });
            
            const responseText = await directResponse.text();
            console.log('ç›´æ¥è°ƒç”¨å“åº”çŠ¶æ€:', directResponse.status);
            console.log('ç›´æ¥è°ƒç”¨å“åº”æ–‡æœ¬:', responseText);
            
            // å¦‚æœå“åº”æˆåŠŸï¼Œè¯´æ˜é—®é¢˜å¯èƒ½æ˜¯ Supabase å®¢æˆ·ç«¯çš„é—®é¢˜
            if (directResponse.ok) {
              try {
                const successData = JSON.parse(responseText);
                // å¦‚æœç›´æ¥è°ƒç”¨æˆåŠŸï¼Œè¯´æ˜ Supabase å®¢æˆ·ç«¯æœ‰é—®é¢˜ï¼Œä½†æˆ‘ä»¬ä»ç„¶æ˜¾ç¤ºæˆåŠŸçš„ç»“æœ
                console.warn('ç›´æ¥è°ƒç”¨æˆåŠŸï¼Œä½† Supabase å®¢æˆ·ç«¯è¿”å›é”™è¯¯ã€‚è¿™å¯èƒ½æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯é—®é¢˜ã€‚');
                data = successData;
                error = null; // æ¸…é™¤é”™è¯¯ï¼Œå› ä¸ºå®é™…ä¸Šè°ƒç”¨æˆåŠŸäº†
              } catch (e) {
                // è§£æå¤±è´¥ï¼Œç»§ç»­æ˜¾ç¤ºé”™è¯¯
                console.error('è§£ææˆåŠŸå“åº”å¤±è´¥:', e);
              }
            } else {
              // å“åº”å¤±è´¥ï¼Œè§£æé”™è¯¯ä¿¡æ¯
              try {
                error.serverError = JSON.parse(responseText);
                console.log('è§£æåçš„æœåŠ¡å™¨é”™è¯¯:', error.serverError);
              } catch (e) {
                error.serverError = { 
                  raw: responseText, 
                  status: directResponse.status, 
                  statusText: directResponse.statusText,
                  parseError: e.message
                };
              }
              
              // æ›´æ–°é”™è¯¯çŠ¶æ€ç 
              if (!error.status && directResponse.status) {
                error.status = directResponse.status;
              }
            }
          } catch (fetchError) {
            console.error('Failed to fetch error details directly:', fetchError);
            error.fetchError = fetchError.message;
          }
        }

        if (error) {
          statusBadge.className = 'status-badge status-error';
          statusBadge.textContent = 'å¤±è´¥';
          
          // è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
          let errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
          let errorDetails = '';
          
          // å°è¯•ä»å“åº”ä¸­è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
          let serverError = null;
          if (error.context && error.context.body) {
            try {
              serverError = typeof error.context.body === 'string' 
                ? JSON.parse(error.context.body) 
                : error.context.body;
            } catch (e) {
              serverError = { raw: error.context.body };
            }
          } else if (error.serverError) {
            // ä½¿ç”¨ç›´æ¥è°ƒç”¨è·å–çš„é”™è¯¯ä¿¡æ¯
            serverError = error.serverError;
          }
          
          // æ£€æŸ¥å¸¸è§é”™è¯¯ç±»å‹
          if (error.name === 'FunctionsHttpError') {
            errorMessage = `Edge Function è¿”å›äº†é”™è¯¯çŠ¶æ€ç ${error.status ? ` (${error.status})` : ''}`;
            errorDetails = `
              <div class="mt-4 space-y-3">
                <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                  <p class="font-semibold text-yellow-800 mb-2">âš ï¸ FunctionsHttpError - Edge Function è¢«è°ƒç”¨ä½†è¿”å›äº†é”™è¯¯</p>
                  <p class="text-sm text-yellow-700">è¿™é€šå¸¸è¡¨ç¤º Edge Function å·²éƒ¨ç½²ï¼Œä½†æ‰§è¡Œæ—¶å‡ºç°äº†é”™è¯¯</p>
                </div>
            `;
            
            if (error.status === 500) {
              errorDetails += `
                <p class="font-semibold mt-3">å¯èƒ½çš„åŸå› ï¼š</p>
                <ul class="list-disc list-inside space-y-1 ml-4">
                  <li><strong>ç¯å¢ƒå˜é‡æœªè®¾ç½®æˆ–æ ¼å¼ä¸æ­£ç¡®</strong>ï¼ˆBAIDU_API_KEYï¼‰</li>
                  <li>API Key æ— æ•ˆæˆ–å·²è¿‡æœŸ</li>
                  <li>Edge Function ä»£ç æ‰§è¡Œé”™è¯¯</li>
                  <li>ç™¾åº¦ API è°ƒç”¨å¤±è´¥</li>
                </ul>
                <p class="mt-3 font-semibold">ğŸ”§ æ’æŸ¥æ­¥éª¤ï¼š</p>
                <ol class="list-decimal list-inside space-y-2 ml-4">
                  <li>æ£€æŸ¥ç¯å¢ƒå˜é‡ï¼š<pre class="bg-gray-100 p-2 rounded text-sm mt-1 inline-block">npx supabase secrets list</pre></li>
                  <li>æŸ¥çœ‹ Edge Function æ—¥å¿—ï¼š<pre class="bg-gray-100 p-2 rounded text-sm mt-1 inline-block">npx supabase functions logs ask-ai</pre></li>
                  <li>ç¡®è®¤ API Key æ ¼å¼æ­£ç¡®ï¼ˆåº”è¯¥æ˜¯ <code>bce-v3/xxx</code> æ ¼å¼ï¼‰</li>
                </ol>
              `;
            } else if (error.status === 400) {
              errorDetails += `
                <p class="font-semibold mt-3">å¯èƒ½çš„åŸå› ï¼š</p>
                <ul class="list-disc list-inside space-y-1 ml-4">
                  <li>è¯·æ±‚æ ¼å¼ä¸æ­£ç¡®</li>
                  <li>ç¼ºå°‘å¿…éœ€çš„å­—æ®µ</li>
                  <li>JSON è§£æå¤±è´¥</li>
                </ul>
              `;
            } else if (error.status === 404) {
              errorDetails += `
                <p class="font-semibold mt-3">Edge Function æœªæ‰¾åˆ°</p>
                <p>è¯·è¿è¡Œï¼š<pre class="bg-gray-100 p-2 rounded text-sm mt-1 inline-block">npx supabase functions deploy ask-ai</pre></p>
              `;
            } else {
              errorDetails += `
                <p class="font-semibold mt-3">çŠ¶æ€ç ï¼š${error.status || 'æœªçŸ¥'}</p>
                <p>è¯·æŸ¥çœ‹ä¸‹æ–¹æœåŠ¡å™¨è¿”å›çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯</p>
              `;
            }
            
            errorDetails += `</div>`;
          } else if (error.name === 'FunctionsFetchError' || (error.message && error.message.includes('Failed to send'))) {
            errorMessage = 'æ— æ³•è¿æ¥åˆ° Edge Function (FunctionsFetchError)';
            errorDetails = `
              <div class="mt-4 space-y-3">
                <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                  <p class="font-semibold text-yellow-800 mb-2">âš ï¸ è¿™æ˜¯æœ€å¸¸è§çš„é”™è¯¯ï¼Œé€šå¸¸è¡¨ç¤º Edge Function æœªéƒ¨ç½²</p>
                </div>
                <p class="font-semibold">å¯èƒ½çš„åŸå› ï¼š</p>
                <ul class="list-disc list-inside space-y-1 ml-4">
                  <li><strong>Edge Function æœªéƒ¨ç½²</strong>ï¼ˆæœ€å¸¸è§ï¼‰</li>
                  <li>Supabase URL æˆ– Anon Key ä¸æ­£ç¡®</li>
                  <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
                  <li>CORS é…ç½®é—®é¢˜</li>
                </ul>
                <p class="mt-3 font-semibold">ğŸ”§ å¿«é€Ÿä¿®å¤æ­¥éª¤ï¼š</p>
                <ol class="list-decimal list-inside space-y-2 ml-4">
                  <li>
                    <strong>å®‰è£… Supabase CLIï¼ˆå¦‚æœæœªå®‰è£…ï¼‰ï¼š</strong>
                    <pre class="bg-gray-100 p-2 rounded text-sm mt-1">npm install -g supabase</pre>
                  </li>
                  <li>
                    <strong>ç™»å½• Supabaseï¼š</strong>
                    <pre class="bg-gray-100 p-2 rounded text-sm mt-1">supabase login</pre>
                  </li>
                  <li>
                    <strong>é“¾æ¥åˆ°é¡¹ç›®ï¼š</strong>
                    <pre class="bg-gray-100 p-2 rounded text-sm mt-1">supabase link --project-ref naqyczuuariosniudbsr</pre>
                  </li>
                  <li>
                    <strong>è®¾ç½®ç¯å¢ƒå˜é‡ï¼š</strong>
                    <pre class="bg-gray-100 p-2 rounded text-sm mt-1">supabase secrets set BAIDU_API_KEY=bce-v3/your_api_key_here</pre>
                  </li>
                  <li>
                    <strong>éƒ¨ç½² Edge Functionï¼š</strong>
                    <pre class="bg-gray-100 p-2 rounded text-sm mt-1">supabase functions deploy ask-ai</pre>
                  </li>
                  <li>
                    <strong>éªŒè¯éƒ¨ç½²ï¼š</strong>
                    <pre class="bg-gray-100 p-2 rounded text-sm mt-1">supabase functions list</pre>
                  </li>
                </ol>
                <div class="mt-3 bg-blue-50 border border-blue-200 rounded p-3">
                  <p class="font-semibold text-blue-800 mb-1">ğŸ“š è¯¦ç»†æ–‡æ¡£ï¼š</p>
                  <ul class="list-disc list-inside space-y-1 text-sm text-blue-700">
                    <li><code class="bg-blue-100 px-1 rounded">FIX_FUNCTIONSFETCHERROR.md</code> - å®Œæ•´ä¿®å¤æŒ‡å—</li>
                    <li><code class="bg-blue-100 px-1 rounded">EDGE_FUNCTION_ERROR_FIX.md</code> - é”™è¯¯ä¿®å¤æŒ‡å—</li>
                    <li><code class="bg-blue-100 px-1 rounded">QUICK_FIX_EDGE_FUNCTION.md</code> - å¿«é€Ÿä¿®å¤æŒ‡å—</li>
                  </ul>
                </div>
              </div>
            `;
          } else if (error.status === 404) {
            errorMessage = 'Edge Function æœªæ‰¾åˆ° (404)';
            errorDetails = `
              <div class="mt-4 space-y-2">
                <p class="font-semibold">Edge Function å¯èƒ½æœªéƒ¨ç½²</p>
                <p>è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤éƒ¨ç½²ï¼š</p>
                <pre class="bg-gray-100 p-2 rounded text-sm">supabase functions deploy ask-ai</pre>
              </div>
            `;
          } else if (error.status === 500) {
            errorMessage = 'Edge Function æœåŠ¡å™¨é”™è¯¯ (500)';
            errorDetails = `
              <div class="mt-4 space-y-2">
                <p class="font-semibold">å¯èƒ½çš„åŸå› ï¼š</p>
                <ul class="list-disc list-inside space-y-1 ml-4">
                  <li>ç¯å¢ƒå˜é‡æœªè®¾ç½®ï¼ˆBAIDU_API_KEYï¼‰</li>
                  <li>Edge Function ä»£ç æœ‰é”™è¯¯</li>
                  <li>API Key æ— æ•ˆæˆ–æ ¼å¼ä¸æ­£ç¡®</li>
                  <li>ç™¾åº¦ API è°ƒç”¨å¤±è´¥</li>
                </ul>
                <p>è¯·æ£€æŸ¥ Supabase æ—¥å¿—ï¼š<code class="bg-gray-200 px-1 rounded">supabase functions logs ask-ai</code></p>
              </div>
            `;
          } else if (error.status === 400) {
            errorMessage = 'è¯·æ±‚æ ¼å¼é”™è¯¯ (400)';
            errorDetails = `
              <div class="mt-4 space-y-2">
                <p class="font-semibold">å¯èƒ½çš„åŸå› ï¼š</p>
                <ul class="list-disc list-inside space-y-1 ml-4">
                  <li>è¯·æ±‚ä½“æ ¼å¼ä¸æ­£ç¡®</li>
                  <li>ç¼ºå°‘å¿…éœ€çš„ prompt å­—æ®µ</li>
                  <li>JSON è§£æå¤±è´¥</li>
                </ul>
              </div>
            `;
          }
          
          // å¦‚æœæœ‰æœåŠ¡å™¨è¿”å›çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œæ˜¾ç¤ºå®ƒ
          if (serverError) {
            errorDetails += `
              <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded">
                <p class="font-semibold text-yellow-800 mb-2">ğŸ“‹ æœåŠ¡å™¨è¿”å›çš„é”™è¯¯è¯¦æƒ…ï¼š</p>
                <pre class="bg-white p-3 rounded text-sm overflow-auto">${JSON.stringify(serverError, null, 2)}</pre>
              </div>
            `;
          } else if (error.name === 'FunctionsHttpError') {
            // å³ä½¿æ²¡æœ‰ serverErrorï¼Œä¹Ÿæä¾›è¯Šæ–­ä¿¡æ¯
            errorDetails += `
              <div class="mt-4 p-4 bg-orange-50 border border-orange-200 rounded">
                <p class="font-semibold text-orange-800 mb-2">âš ï¸ æ— æ³•è·å–æœåŠ¡å™¨è¯¦ç»†é”™è¯¯ä¿¡æ¯</p>
                <p class="text-sm text-orange-700 mb-2">è¿™å¯èƒ½æ˜¯å› ä¸ºï¼š</p>
                <ul class="list-disc list-inside space-y-1 ml-4 text-sm text-orange-700">
                  <li>Edge Function è¿”å›äº†ç©ºå“åº”</li>
                  <li>å“åº”æ ¼å¼ä¸æ˜¯ JSON</li>
                  <li>ç½‘ç»œé—®é¢˜å¯¼è‡´å“åº”ä¸¢å¤±</li>
                </ul>
                <p class="mt-3 text-sm text-orange-700">
                  <strong>å»ºè®®ï¼š</strong>è¿è¡Œ <code class="bg-orange-100 px-1 rounded">npx supabase functions logs ask-ai</code> æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
                </p>
              </div>
            `;
          }
          
          statusMessage.textContent = `é”™è¯¯ï¼š${errorMessage}`;
          
          resultsSection.style.display = 'block';
          resultsDiv.innerHTML = `
            <div class="text-red-600 font-semibold mb-2">âŒ è°ƒç”¨å¤±è´¥</div>
            <div class="mb-4">
              <strong>é”™è¯¯ä¿¡æ¯ï¼š</strong>
              <pre class="mt-2 bg-red-50 p-4 rounded text-sm overflow-auto">${JSON.stringify(error, null, 2)}</pre>
            </div>
            ${errorDetails}
            <div class="mt-4">
              <strong>å®Œæ•´é”™è¯¯å¯¹è±¡ï¼š</strong>
              <pre class="mt-2 bg-gray-100 p-3 rounded text-sm overflow-auto">${JSON.stringify(error, null, 2)}</pre>
            </div>
          `;
          
          // åœ¨æ§åˆ¶å°è¾“å‡ºè¯¦ç»†é”™è¯¯
          console.error('âŒ Edge Function è°ƒç”¨å¤±è´¥:', error);
          console.error('è¯·æ±‚ URL:', functionUrl);
          console.error('é”™è¯¯è¯¦æƒ…:', error);
        } else {
          statusBadge.className = 'status-badge status-success';
          statusBadge.textContent = 'æˆåŠŸ';
          statusMessage.textContent = `å“åº”æ—¶é—´ï¼š${duration}ms`;

          resultsSection.style.display = 'block';
          resultsDiv.innerHTML = `
            <div class="text-green-600 font-semibold mb-2">âœ… è°ƒç”¨æˆåŠŸ</div>
            <div class="mb-4">
              <strong>AI å›åº”ï¼š</strong>
              <div class="mt-2 p-4 bg-white rounded border border-gray-200">
                ${data.response ? data.response.replace(/\n/g, '<br>') : 'æ— å›åº”'}
              </div>
            </div>
            ${data.usage ? `
              <div class="mb-4">
                <strong>ä½¿ç”¨ç»Ÿè®¡ï¼š</strong>
                <pre class="mt-2 bg-gray-100 p-3 rounded text-sm">${JSON.stringify(data.usage, null, 2)}</pre>
              </div>
            ` : ''}
            <div>
              <strong>å®Œæ•´å“åº”ï¼š</strong>
              <pre class="mt-2 bg-gray-100 p-3 rounded text-sm overflow-auto">${JSON.stringify(data, null, 2)}</pre>
            </div>
          `;
        }
      } catch (error) {
        statusBadge.className = 'status-badge status-error';
        statusBadge.textContent = 'å¼‚å¸¸';
        
        let errorMessage = error.message || 'æœªçŸ¥å¼‚å¸¸';
        let errorDetails = '';
        
        // æ£€æŸ¥å¸¸è§å¼‚å¸¸ç±»å‹
        if (error.name === 'FunctionsFetchError' || (error.message && error.message.includes('Failed to send'))) {
          errorMessage = 'æ— æ³•å‘é€è¯·æ±‚åˆ° Edge Function (FunctionsFetchError)';
          errorDetails = `
            <div class="mt-4 space-y-3">
              <div class="bg-red-50 border border-red-200 rounded p-3">
                <p class="font-semibold text-red-800 mb-2">âŒ FunctionsFetchError - Edge Function è¿æ¥å¤±è´¥</p>
                <p class="text-sm text-red-700">è¿™é€šå¸¸è¡¨ç¤º Edge Function æœªéƒ¨ç½²æˆ–é…ç½®ä¸æ­£ç¡®</p>
              </div>
              <p class="font-semibold">ğŸ”§ ç«‹å³ä¿®å¤ï¼š</p>
              <div class="bg-gray-50 border border-gray-200 rounded p-3">
                <p class="text-sm font-mono mb-2">1. å®‰è£… Supabase CLIï¼ˆå¦‚æœæœªå®‰è£…ï¼‰ï¼š</p>
                <pre class="bg-gray-100 p-2 rounded text-sm">npm install -g supabase</pre>
                <p class="text-sm font-mono mt-3 mb-2">2. éƒ¨ç½² Edge Functionï¼š</p>
                <pre class="bg-gray-100 p-2 rounded text-sm">supabase login
supabase link --project-ref naqyczuuariosniudbsr
supabase secrets set BAIDU_API_KEY=bce-v3/your_key
supabase functions deploy ask-ai</pre>
              </div>
              <p class="mt-3 text-sm text-gray-600">ğŸ“– æŸ¥çœ‹ <code class="bg-gray-200 px-1 rounded">FIX_FUNCTIONSFETCHERROR.md</code> è·å–å®Œæ•´ä¿®å¤æŒ‡å—</p>
            </div>
          `;
        } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
          errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥';
          errorDetails = `
            <div class="mt-4 space-y-2">
              <p class="font-semibold">ç½‘ç»œè¯·æ±‚å¼‚å¸¸</p>
              <p>è¯·æ£€æŸ¥ï¼š</p>
              <ul class="list-disc list-inside space-y-1 ml-4">
                <li>ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</li>
                <li>Supabase URL æ˜¯å¦æ­£ç¡®</li>
                <li>æ˜¯å¦æœ‰é˜²ç«å¢™æˆ–ä»£ç†é˜»æ­¢è¯·æ±‚</li>
              </ul>
            </div>
          `;
        }
        
        statusMessage.textContent = `å¼‚å¸¸ï¼š${errorMessage}`;
        
        resultsSection.style.display = 'block';
        resultsDiv.innerHTML = `
          <div class="text-red-600 font-semibold mb-2">âŒ å‘ç”Ÿå¼‚å¸¸</div>
          <div class="mb-4">
            <strong>å¼‚å¸¸ä¿¡æ¯ï¼š</strong>
            <pre class="mt-2 bg-red-50 p-4 rounded text-sm overflow-auto">${error.stack || error.message}</pre>
          </div>
          ${errorDetails}
          <div class="mt-4">
            <strong>å®Œæ•´å¼‚å¸¸å¯¹è±¡ï¼š</strong>
            <pre class="mt-2 bg-gray-100 p-3 rounded text-sm overflow-auto">${JSON.stringify(error, Object.getOwnPropertyNames(error), 2)}</pre>
          </div>
        `;
        
        // åœ¨æ§åˆ¶å°è¾“å‡ºè¯¦ç»†å¼‚å¸¸
        console.error('âŒ å‘ç”Ÿå¼‚å¸¸:', error);
        console.error('å¼‚å¸¸å †æ ˆ:', error.stack);
      }
    });

    // è¯Šæ–­è¿æ¥
    safeAddEventListener('diagnose-btn', 'click', async () => {
      if (!initSupabase()) return;

      const statusDiv = document.getElementById('test-status');
      const statusBadge = document.getElementById('status-badge');
      const statusMessage = document.getElementById('status-message');
      const resultsSection = document.getElementById('test-results-section');
      const resultsDiv = document.getElementById('test-results');

      statusDiv.classList.remove('hidden');
      statusBadge.className = 'status-badge status-pending';
      statusBadge.textContent = 'è¯Šæ–­ä¸­...';
      statusMessage.textContent = 'æ­£åœ¨æ£€æŸ¥è¿æ¥...';
      resultsSection.style.display = 'none';

      const diagnostics = [];
      const supabaseUrl = getElementValue('supabase-url');
      const supabaseKey = getElementValue('supabase-key');
      const functionUrl = `${supabaseUrl}/functions/v1/ask-ai`;

      // 1. æ£€æŸ¥ Supabase URL æ ¼å¼
      try {
        const url = new URL(supabaseUrl);
        diagnostics.push({ check: 'Supabase URL æ ¼å¼', status: 'âœ…', message: `æ ¼å¼æ­£ç¡®: ${url.hostname}` });
      } catch (e) {
        diagnostics.push({ check: 'Supabase URL æ ¼å¼', status: 'âŒ', message: `æ ¼å¼é”™è¯¯: ${e.message}` });
      }

      // 2. æ£€æŸ¥ Anon Key
      if (supabaseKey && supabaseKey.length > 20) {
        diagnostics.push({ check: 'Supabase Anon Key', status: 'âœ…', message: 'å·²å¡«å†™ï¼ˆé•¿åº¦æ­£å¸¸ï¼‰' });
      } else {
        diagnostics.push({ check: 'Supabase Anon Key', status: 'âŒ', message: 'æœªå¡«å†™æˆ–æ ¼å¼ä¸æ­£ç¡®' });
      }

      // 3. æ£€æŸ¥ Supabase å®¢æˆ·ç«¯
      if (supabaseClient) {
        diagnostics.push({ check: 'Supabase å®¢æˆ·ç«¯', status: 'âœ…', message: 'å·²åˆå§‹åŒ–' });
      } else {
        diagnostics.push({ check: 'Supabase å®¢æˆ·ç«¯', status: 'âŒ', message: 'æœªåˆå§‹åŒ–' });
      }

      // 4. æµ‹è¯• Edge Function è¿æ¥
      try {
        const { data, error } = await supabaseClient.functions.invoke('ask-ai', {
          body: { prompt: 'è¯Šæ–­æµ‹è¯•', history: [] }
        });

        if (error) {
          diagnostics.push({ 
            check: 'Edge Function è¿æ¥', 
            status: 'âŒ', 
            message: `è¿æ¥å¤±è´¥: ${error.message || JSON.stringify(error)}`,
            details: error
          });
        } else {
          diagnostics.push({ 
            check: 'Edge Function è¿æ¥', 
            status: 'âœ…', 
            message: 'è¿æ¥æˆåŠŸï¼Edge Function æ­£å¸¸å·¥ä½œ',
            details: data
          });
        }
      } catch (error) {
        diagnostics.push({ 
          check: 'Edge Function è¿æ¥', 
          status: 'âŒ', 
          message: `è¿æ¥å¼‚å¸¸: ${error.message}`,
          details: error
        });
      }

      // 5. æ£€æŸ¥ç½‘ç»œè¿æ¥
      try {
        const response = await fetch(supabaseUrl, { method: 'HEAD', mode: 'no-cors' });
        diagnostics.push({ check: 'ç½‘ç»œè¿æ¥', status: 'âœ…', message: 'å¯ä»¥è®¿é—® Supabase æœåŠ¡å™¨' });
      } catch (error) {
        diagnostics.push({ check: 'ç½‘ç»œè¿æ¥', status: 'âš ï¸', message: `å¯èƒ½æ— æ³•è®¿é—®: ${error.message}` });
      }

      // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
      const allPassed = diagnostics.every(d => d.status === 'âœ…');
      statusBadge.className = allPassed ? 'status-badge status-success' : 'status-badge status-error';
      statusBadge.textContent = allPassed ? 'è¯Šæ–­å®Œæˆ' : 'å‘ç°é—®é¢˜';
      statusMessage.textContent = allPassed ? 'æ‰€æœ‰æ£€æŸ¥é€šè¿‡' : 'å‘ç°ä¸€äº›é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦æƒ…';

      resultsSection.style.display = 'block';
      resultsDiv.innerHTML = `
        <div class="space-y-4">
          <h3 class="text-lg font-semibold text-gray-800">è¯Šæ–­ç»“æœ</h3>
          <div class="space-y-2">
            ${diagnostics.map(d => `
              <div class="flex items-start p-3 rounded border ${d.status === 'âœ…' ? 'bg-green-50 border-green-200' : d.status === 'âŒ' ? 'bg-red-50 border-red-200' : 'bg-yellow-50 border-yellow-200'}">
                <span class="text-xl mr-3">${d.status}</span>
                <div class="flex-1">
                  <div class="font-semibold">${d.check}</div>
                  <div class="text-sm text-gray-600 mt-1">${d.message}</div>
                  ${d.details ? `
                    <details class="mt-2">
                      <summary class="text-sm text-blue-600 cursor-pointer">æŸ¥çœ‹è¯¦æƒ…</summary>
                      <pre class="mt-2 bg-gray-100 p-2 rounded text-xs overflow-auto">${JSON.stringify(d.details, null, 2)}</pre>
                    </details>
                  ` : ''}
                </div>
              </div>
            `).join('')}
          </div>
          ${!allPassed ? `
            <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded">
              <h4 class="font-semibold text-blue-800 mb-2">ğŸ’¡ ä¿®å¤å»ºè®®ï¼š</h4>
              <ul class="list-disc list-inside space-y-1 text-sm text-blue-700">
                <li>å¦‚æœ Edge Function æœªéƒ¨ç½²ï¼Œè¯·è¿è¡Œï¼š<code class="bg-blue-100 px-1 rounded">supabase functions deploy ask-ai</code></li>
                <li>å¦‚æœç¯å¢ƒå˜é‡æœªè®¾ç½®ï¼Œè¯·è¿è¡Œï¼š<code class="bg-blue-100 px-1 rounded">supabase secrets set BAIDU_API_KEY=your_key</code></li>
                <li>æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ï¼š<code class="bg-blue-100 px-1 rounded">QUICK_FIX_EDGE_FUNCTION.md</code></li>
                <li>æ£€æŸ¥æµè§ˆå™¨ Console å’Œ Network æ ‡ç­¾è·å–æ›´å¤šä¿¡æ¯</li>
              </ul>
            </div>
          ` : ''}
        </div>
      `;

      console.log('è¯Šæ–­ç»“æœ:', diagnostics);
    });

    // ç”Ÿæˆ API è¯·æ±‚æ ¼å¼
    safeAddEventListener('generate-request-btn', 'click', () => {
      const userMessage = getElementValue('user-message');
      const systemPrompt = getElementValue('system-prompt');

      const messages = [];
      if (systemPrompt.trim()) {
        messages.push({ role: 'user', content: systemPrompt });
      }
      messages.push({ role: 'user', content: userMessage });

      const requestBody = {
        model: 'ernie-4.5-turbo-128k',
        messages: messages,
        temperature: 0.7,
        max_tokens: 2000,
        stream: false
      };

      // æ˜¾ç¤ºè¯·æ±‚æ ¼å¼
      document.getElementById('request-format-section').style.display = 'block';
      
      document.getElementById('http-request').textContent = `POST https://qianfan.baidubce.com/v2/chat/completions
Content-Type: application/json
Authorization: Bearer YOUR_API_KEY_OR_ACCESS_TOKEN`;

      document.getElementById('request-body').textContent = JSON.stringify(requestBody, null, 2);

      // æ›´æ–°ä»£ç ç¤ºä¾‹
      document.getElementById('js-example').textContent = `// é€šè¿‡ Supabase Edge Function è°ƒç”¨
const { data, error } = await supabase.functions.invoke('ask-ai', {
  body: {
    prompt: ${JSON.stringify(userMessage)},
    history: [] // å¯é€‰ï¼šå¯¹è¯å†å²
  }
});

if (error) {
  console.error('é”™è¯¯ï¼š', error);
} else {
  console.log('AI å›åº”ï¼š', data.response);
}`;

      document.getElementById('edge-function-example').textContent = `// supabase/functions/ask-ai/index.ts
const apiUrl = 'https://qianfan.baidubce.com/v2/chat/completions';

const response = await fetch(apiUrl, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': \`Bearer \${authToken}\` // API Key æˆ– Access Token
  },
  body: JSON.stringify(${JSON.stringify(requestBody, null, 2)})
});

const data = await response.json();
const aiResponse = data.choices[0].message.content;`;

      document.getElementById('curl-example').textContent = `curl -X POST https://qianfan.baidubce.com/v2/chat/completions \\\n  -H "Content-Type: application/json" \\\n  -H "Authorization: Bearer YOUR_API_KEY" \\\n  -d '${JSON.stringify(requestBody)}'`;
    });

    // é¡µé¢åŠ è½½æ—¶å°è¯•ä» app.js è¯»å–é…ç½®
    window.addEventListener('DOMContentLoaded', () => {
      // å¦‚æœ Supabase Key ä¸ºç©ºï¼Œå°è¯•ä» localStorage è¯»å–
      const savedKey = localStorage.getItem('supabase_anon_key');
      if (savedKey) {
        setElementValue('supabase-key', savedKey);
      }
    });

    // ä¿å­˜ Supabase Keyï¼ˆå¯é€‰ï¼‰
    safeAddEventListener('supabase-key', 'change', (e) => {
      if (e.target.value) {
        localStorage.setItem('supabase_anon_key', e.target.value);
      }
    });
  </script>
</body>
</html>

